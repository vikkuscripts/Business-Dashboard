<!DOCTYPE html>
<html lang="en">

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
        integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <?!= include('CSS'); ?>
    <style>
        /* Profile Dropdown Styles */
        .user-profile-container {
            position: relative;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 5px 10px;
            border-radius: 50px;
            transition: background-color 0.2s;
        }

        .user-profile-container:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #1A7499;
            background-color: #f0f0f0;
        }

        .profile-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 10px;
            background-color: white;
            min-width: 200px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            display: none;
            flex-direction: column;
            z-index: 1000;
            overflow: hidden;
            border: 1px solid #eee;
            animation: slideDown 0.2s ease-out;
        }

        .profile-dropdown.show {
            display: flex;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .dropdown-header {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            background-color: #f8f9fa;
        }

        .dropdown-user-name {
            font-weight: 700;
            color: #333;
            font-size: 14px;
            display: block;
        }

        .dropdown-user-email {
            font-size: 12px;
            color: #777;
        }

        .dropdown-item-custom {
            padding: 12px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #444;
            text-decoration: none;
            transition: background-color 0.2s;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 14px;
        }

        .dropdown-item-custom:hover {
            background-color: #f1f5f9;
            color: #1A7499;
        }

        .dropdown-item-custom i {
            width: 18px;
            color: #64748b;
        }

        .dropdown-item-custom.logout-item:hover {
            color: #e11d48;
            background-color: #fff1f2;
        }

        .dropdown-item-custom.logout-item:hover i {
            color: #e11d48;
        }

        /* Initials Avatar Styles */
        .user-initials.large {
            width: 80px;
            height: 80px;
            font-size: 36px;
            margin: 0 auto;
        }

        .user-avatar-wrapper {
            position: relative;
            width: 40px;
            height: 40px;
        }

        /* Updated Dropdown Styles - Sketch Match */
        .profile-dropdown {
            width: 260px;
            padding: 20px;
            background: #e9eef6;
            color: #3c4043;
            border-radius: 20px;
            text-align: center;
            border: 1px solid #d1d9e0;
            right: 10px;
            top: 110%;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .dropdown-close {
            position: absolute;
            top: 12px;
            right: 12px;
            cursor: pointer;
            color: #5f6368;
            font-size: 16px;
            padding: 4px;
        }

        .dropdown-email {
            font-size: 13px;
            color: #5f6368;
            margin-bottom: 15px;
            font-weight: 500;
            word-break: break-all;
        }

        .dropdown-avatar-container {
            margin: 0 auto 12px;
            position: relative;
            width: 70px;
            height: 70px;
        }

        .dropdown-avatar {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            object-fit: cover;
            border: 1px solid #ddd;
        }

        .dropdown-greeting {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
        }

        /* Bottom Row Buttons (Sketch Layout) */
        /* Bottom Row Buttons (Sketch Layout - Flush Tray) */
        .dropdown-footer {
            display: flex;
            background: #ffffff;
            border-top: 1px solid #d1d9e0;
            margin-top: 15px;
            /* Negative margins to pull footer to edges ignoring parent padding */
            margin-left: -20px;
            margin-right: -20px;
            margin-bottom: -20px;
            border-bottom-left-radius: 20px;
            /* Match parent radius */
            border-bottom-right-radius: 20px;
        }

        .footer-btn {
            flex: 1;
            padding: 12px 4px;
            /* Slightly taller for easy clicking */
            border: none;
            background: transparent;
            color: #000000;
            font-size: 11px;
            font-weight: 600;
            /* Bold for clearer small text */
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.2s;
            border-right: 1px solid #d1d9e0;
        }

        .footer-btn:last-child {
            border-right: none;
        }

        .footer-btn:hover {
            background-color: #f8f9fa;
        }

        /* Ensure rounded corners for hover state on the buttons too */
        .footer-btn:first-child:hover {
            border-bottom-left-radius: 20px;
        }

        .footer-btn:last-child:hover {
            border-bottom-right-radius: 20px;
        }

        /* Ensure text is black, small, and visible */
        .footer-btn span {
            color: #000000;
            white-space: nowrap;
            font-size: 10px;
            /* Force small size */
        }

        /* Red color on hover in signout */
        .footer-btn:last-child:hover {
            color: #d93025;
        }

        .footer-btn:last-child:hover i,
        .footer-btn:last-child:hover span {
            color: #d93025;
        }

        .footer-btn i {
            font-size: 13px;
            /* Slightly larger icon */
            color: #333;
        }
    </style>
</head>

<body onload="onLoad()">
    <!-- Global Loader Overlay -->
    <div id="globalLoader" style="display: flex;">
        <div class="loader">
            <div class="circle"></div>
            <div class="circle"></div>
            <div class="circle"></div>
            <div class="circle"></div>
        </div>
    </div>
    <!-- Navigation Bar (inspiration-style) -->
    <header class="navbar">
        <div class="flex flex-row item-center h-full">
            <button id="burger" onclick="toggleSidebar()" style="display: none;">
                <i class="fas fa-bars"></i>
            </button>
            <img id="companyLogo" alt="Company Logo" style="height:36px; margin-right:10px;">
            <h2 id="businessTitle" class="" style="padding:10px 0; font-weight: 800;"></h2>
        </div>
        <div class="flex flex-row justify-between gap-5 item-center">
            <div id="profileTrigger" class="user-profile-container" style="display: none;"
                onclick="toggleProfileDropdown(event)">
                <div class="text-right d-none d-md-block">
                    <span id="navDisplayName" style="font-weight: 600; font-size: 14px; color: #faf9f9;">User</span>
                </div>
                <div class="user-avatar-wrapper">
                    <img id="navUserAvatar" src="" class="user-avatar" alt=" " onerror="handleAvatarError()"
                        style="display: none;">
                    <div id="navUserInitials" class="user-initials" style="display: none;"></div>
                </div>

                <div id="userDropdownMenu" class="profile-dropdown">
                    <div class="dropdown-close" onclick="toggleProfileDropdown(event)">
                        <i class="fas fa-times"></i>
                    </div>

                    <!-- Sequence: Email > Image > Name > Buttons -->
                    <div id="dropdownUserEmail" class="dropdown-email">user@example.com</div>

                    <div class="dropdown-avatar-container">
                        <img id="dropdownAvatar" src="" class="dropdown-avatar" alt=" "
                            onerror="handleDropdownAvatarError()" style="display: none;">
                        <div id="dropdownInitials" class="user-initials large" style="display: none;"></div>
                    </div>

                    <div id="dropdownDisplayName" class="dropdown-greeting">Hi, User!</div>

                    <div class="dropdown-footer">
                        <button class="footer-btn" onclick="alert('Update Profile logic later')">
                            <i class="fas fa-user-gear"></i> <span>Update profile</span>
                        </button>
                        <button class="footer-btn" onclick="handleLogout()">
                            <i class="fas fa-right-from-bracket"></i> <span>Sign out</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Bootstrap Alert for Login/Logout Messages -->
        <div id="responseMessage" class="alert"
            style="display: none; position: absolute; left: 50%; transform: translateX(-50%); top: 70px; z-index: 10000;"
            role="alert">
        </div>
        <h1 id="pageName" class="welcome-message d-none" style="color: white; text-align: center;"></h1>
    </header>
    <!-- Overlay for auto-logout warning -->
    <div id="logoutOverlay"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 9999;">
    </div>
    <!-- Auto-logout warning alert -->
    <div id="logoutWarningAlert" class="alert"
        style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10000; width: 90%; max-width: 450px; text-align: center; box-shadow: 0 8px 20px rgba(0,0,0,0.3); background-color: white; color: black; border: 2px solid #e0e0e0; border-radius: 12px; padding: 30px;"
        role="alert">
        <strong style="font-size: 18px; display: block; margin-bottom: 8px;">Inactivity Warning</strong>
        <p style="margin-bottom: 12px;">You will be logged out in <span id="logoutCountdown"
                style="font-weight: bold; font-size: 18px; color: #e74c3c;">10</span> seconds due to inactivity.</p>
        <button id="stayLoggedInBtn" class="btn mt-2"
            style="background-color: #1A7499; color: white; font-weight: bold; border: 2px solid #1A7499; padding: 10px 25px; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; font-size: 14px;">Stay
            Logged In</button>
    </div>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <!-- Spacer with the same height as the navbar -->
        <div style="height: 0;"></div>
        <!--
                <img id="dynamicImage" alt="Dynamic Image" class="user-picture" src="https://static.vecteezy.com/system/resources/previews/021/548/095/original/default-profile-picture-avatar-user-avatar-icon-person-icon-head-icon-profile-picture-icons-default-anonymous-user-male-and-female-businessman-photo-placeholder-social-network-avatar-portrait-free-vector.jpg"/>
                -->
        <!-- User Picture -->
        <li type="button" style="margin-left: 40px;" onclick="loadHomePage()">Home</li>
        <ul></ul>
    </div>

    <!-- Main Container -->
    <main class="main-container" id="mainContainer" style="display: none;">
        <!-- Iframe for external links -->
        <div id="linkContent"
            style="display: none; width: 100%; height: calc(100vh - 110px); overflow: hidden; margin-top: 110px;">
            <iframe id="linkFrame" style="width: 100%; height: 100%; border: none;"></iframe>
        </div>
        <!-- Sheet content (like table data) -->
        <div class="sheet-content h-full" id="sheetContent"></div>
    </main>
    <!-- Existing login-container remains the same class -->
    <div class="login-container">
        <!-- Left half: your current login form -->
        <div class="login-left">
            <h2 class="login-title">Sign in</h2>
            <p class="login-subtitle">Use your email to continue</p>
            <div class="input-container">
                <input type="text" id="username" placeholder="Email">
                <i class="fas fa-envelope input-icon"></i>
            </div>
            <div class="input-container">
                <input type="password" id="password" placeholder="Password">
                <i class="fas fa-eye input-icon" id="togglePassword" onclick="togglePasswordVisibility()"></i>
            </div>
            <select id="role" class="form-control mb-2">
                <option value="" selected>Select Role</option>
                <option value="admin">Admin</option>
                <option value="user">User</option>
            </select>
            <div class="login-actions">
                <a onclick="" class="forgot-password">Forgot password?</a>
                <button class="btn" onclick="handleLogin()">Login</button>
            </div>
        </div>
        <!-- Login Picture -->
        <div class="login-right">
            <img alt="Login Image"
                src="https://i.ibb.co/wFwv088Y/online-registration-or-sign-up-login-for-account-on-smartphone-app-user-interface-with-secure-passwo.jpg" />
        </div>
    </div>
    <footer class="footer py-2 text-black" style="border-top: 0.7px solid black; height: 50px; z-index: 10500;">
        <div class="container d-flex justify-content-between align-items-center">
            <div class="text-left d-flex align-items-center" style="padding:auto;">
                <img src="https://drive.google.com/thumbnail?id=1rZ7v-EkFpmgVh0tond3ql4cMzDSivEEv&sz=200"
                    alt="Company Logo" style="width:30px; height:30px; border-radius:50%; margin-right:10px;">
                <a href="https://www.businessautomations.in/" target="_blank"
                    style="text-decoration: none; color: black; font-size: 15px; font-weight: 500;">Powered By @
                    Business Automations Solutions LLP</a>
            </div>
            <div class="footer-links d-flex align-items-center supportcontact" style="text-decoration: none;">
                <a href="https://your-contact-link.com" target="_blank" class="mx-2"
                    style="color: black;"><u>Contact</u></a>
                <a href="https://your-support-link.com" target="_blank" class="mx-2"
                    style="color: black;"><u>Support</u></a>
                <a href="tel:+918621893237" class="mx-2"><img
                        src="https://img.icons8.com/?size=100&id=53439&format=png&color=000000" alt="Call"
                        class="footer-icon"></a>
                <a href="mailto:koushik.businessautomations@gmail.com" target="_blank" class="mx-2"><img
                        src="https://img.icons8.com/?size=100&id=85500&format=png&color=000000" alt="Email"
                        class="footer-icon"></a>
                <a href="https://www.youtube.com/@businessautomations" target="_blank" class="mx-2"><img
                        src="https://img.icons8.com/?size=100&id=19318&format=png&color=000000" alt="YouTube"
                        class="footer-icon"></a>
                <a href="https://www.linkedin.com/in/business-automations-solutions-llp-a80050203/" target="_blank"
                    class="mx-2"><img src="https://img.icons8.com/?size=100&id=xuvGCOXi8Wyg&format=png&color=000000"
                        alt="LinkedIn" class="footer-icon"></a>
                <!-- Facebook Link -->
                <a href="https://www.facebook.com/your-facebook-profile" target="_blank" class="mx-2"> <img
                        src="https://img.icons8.com/?size=100&id=118497&format=png&color=000000" alt="Facebook"
                        class="footer-icon"></a>
                <!-- Instagram Link -->
                <a href="https://www.instagram.com/your-instagram-profile" target="_blank" class="mx-2"><img
                        src="https://img.icons8.com/?size=100&id=32292&format=png&color=000000" alt="Instagram"
                        class="footer-icon"></a>
            </div>
        </div>
    </footer>
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
        integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script>
        // Variables for inactivity tracking
        let inactivityTimeout;
        let logoutWarningTimeout;
        let countdownInterval;
        const INACTIVITY_TIMEOUT_DURATION = 10 * 60 * 1000; // 10 minutes in milliseconds
        const WARNING_BEFORE_LOGOUT = 10 * 1000; // 10 seconds warning before logout

        // MIS Score 
        var currentMisData = [];

        // Function to reset the inactivity timer
        function resetInactivityTimer() {
            // Clear any existing timeouts and intervals
            clearAllTimers();

            // Only set a new timeout if the user is logged in
            if (localStorage.getItem('userName')) {
                // Set timeout to show warning before actual logout
                inactivityTimeout = setTimeout(showLogoutWarning,
                    INACTIVITY_TIMEOUT_DURATION - WARNING_BEFORE_LOGOUT);
            }
        }

        // Function to clear all timers and hide warning
        function clearAllTimers() {
            if (inactivityTimeout) {
                clearTimeout(inactivityTimeout);
            }
            if (logoutWarningTimeout) {
                clearTimeout(logoutWarningTimeout);
            }
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }

            // Hide the warning alert and overlay if they're visible
            document.getElementById('logoutWarningAlert').style.display = 'none';
            document.getElementById('logoutOverlay').style.display = 'none';
        }

        // Function to show warning before logout
        function showLogoutWarning() {
            // Only proceed if user is still logged in
            if (localStorage.getItem('userName')) {
                const warningAlert = document.getElementById('logoutWarningAlert');
                const countdownElement = document.getElementById('logoutCountdown');
                let secondsLeft = 10;

                // Show the warning alert
                document.getElementById('logoutOverlay').style.display = 'block';
                warningAlert.style.display = 'block';
                countdownElement.textContent = secondsLeft;

                // Start countdown
                countdownInterval = setInterval(() => {
                    secondsLeft--;
                    countdownElement.textContent = secondsLeft;

                    if (secondsLeft <= 0) {
                        clearInterval(countdownInterval);
                    }
                }, 1000);

                // Set timeout for actual logout
                logoutWarningTimeout = setTimeout(autoLogout, WARNING_BEFORE_LOGOUT);
            }
        }

        // Function to automatically logout after inactivity
        function autoLogout() {
            // Clear all timers
            clearAllTimers();

            // Only proceed if user is logged in
            if (localStorage.getItem('userName')) {
                console.log('Auto logout triggered due to inactivity');

                // Show a brief message
                const responseMessage = document.getElementById('responseMessage');
                responseMessage.innerText = 'You have been logged out due to inactivity';
                responseMessage.className = 'alert alert-warning';
                responseMessage.style.display = 'block';

                // Call the existing logout handler
                handleLogout();

                // Hide the message after a few seconds
                setTimeout(() => {
                    responseMessage.style.display = 'none';
                }, 5000);
            }
        }

        // Setup event listeners to track user activity
        function setupInactivityTracking() {
            // List of events to track
            const events = [
                'mousedown', 'mousemove', 'keypress',
                'scroll', 'touchstart', 'click', 'keydown'
            ];

            // Add listeners for each event type
            events.forEach(eventType => {
                document.addEventListener(eventType, resetInactivityTimer, true);
            });

            // Add click handler for the "Stay Logged In" button
            document.getElementById('stayLoggedInBtn').addEventListener('click', function () {
                resetInactivityTimer();

                // Show a brief confirmation message
                const responseMessage = document.getElementById('responseMessage');
                responseMessage.innerText = 'Your session has been extended';
                responseMessage.className = 'alert alert-success';
                responseMessage.style.display = 'block';

                // Hide the message after a few seconds
                setTimeout(() => {
                    responseMessage.style.display = 'none';
                }, 3000);
            });

            // Initial setup of the timer
            resetInactivityTimer();
        }

        // Global username variable
        let userName = '';
        // Retrieve username from localStorage and store it in sessionStorage
        userName = localStorage.getItem('userName');
        if (userName) {
            sessionStorage.setItem('loggedInUsers', userName);
        }

        function openLinkInNewTab() {
            var url = 'https://lookerstudio.google.com/embed/reporting/88139f2d-d2ee-4068-b428-63642819be1f/page/p_d8nwb62ded'
            window.open(url, '_blank');
        }

        const loggedInUser = sessionStorage.getItem('loggedInUsers');

        function loadInitialLoginElements() {
            // Wrap each asynchronous call in a promise
            const dynamicImagePromise = new Promise((resolve) => {
                google.script.run.withSuccessHandler((url) => {
                    // Check if url is empty, null or only whitespace. If so, use the default dummy image.
                    const imgUrl = url && url.trim() !== ""
                        ? url
                        : "https://static.vecteezy.com/system/resources/previews/021/548/095/original/default-profile-picture-avatar-user-avatar-icon-person-icon-head-icon-profile-picture-icons-default-anonymous-user-male-and-female-businessman-photo-placeholder-social-network-avatar-portrait-free-vector.jpg";

                    imageUrl = "https://static.vecteezy.com/system/resources/previews/021/548/095/original/default-profile-picture-avatar-user-avatar-icon-person-icon-head-icon-profile-picture-icons-default-anonymous-user-male-and-female-businessman-photo-placeholder-social-network-avatar-portrait-free-vector.jpg"
                    // document.getElementById('dynamicImage').src = imageUrl;
                    resolve();
                }).getImageUrl();
            });

            const titlePromise = new Promise((resolve) => {
                google.script.run.withSuccessHandler((title) => {
                    document.getElementById('businessTitle').innerText = title;
                    resolve();
                }).getBusinessTitle();
            });

            const loginImagePromise = new Promise((resolve) => {
                // Hardcode the image URL directly
                //document.querySelector('.login-right img').src = "https://drive.google.com/uc?export=view&id=1YUXsgczv0E7B3A_uOBjE0dP3m-h_hSkc";
                resolve();
            });

            // Return a promise that resolves when all promises resolve
            return Promise.all([dynamicImagePromise, titlePromise, loginImagePromise]);
        }

        function onLoad() {
            // Reset any previous iframe state
            document.getElementById('linkContent').style.display = 'none';
            document.getElementById('sheetContent').style.display = 'block';

            // Existing onLoad logic:
            userName = localStorage.getItem('userName');
            const displayName = localStorage.getItem('displayName'); // <-- store name from localStorage

            // Fetch the business title
            google.script.run.withSuccessHandler(function (title) {
                document.getElementById('businessTitle').innerText = title;
            }).getBusinessTitle();

            // Fetch the company logo
            google.script.run.withSuccessHandler(function (logoUrl) {
                document.getElementById('companyLogo').src = logoUrl;
            }).getCompanyLogo();

            // If we have a logged-in user, show main container (pass the displayName and profilePictureUrl!)
            if (userName) {
                const profilePictureUrl = localStorage.getItem('profilePictureUrl');
                showMainContainer(userName, displayName, profilePictureUrl);
                google.script.run.withSuccessHandler(buildSidebar).getMenuStructure(userName);
                loadHomePage();
            }
            // Otherwise, show the login screen
            else {
                showLoginContainer();
                loadInitialLoginElements().then(() => {
                    document.getElementById('globalLoader').style.display = 'none';
                });
            }

            // Add this line at the end of the function
            setupInactivityTracking();
        }

        function successHandler(imageUrl) {
            document.getElementById('dynamicImage').src = imageUrl; // Update the img src with the URL
        }

        function successHandlerTitle(title) {
            document.getElementById('businessTitle').innerText = title; // Update the h2 text
        }

        // Show main content when logged in
        function showMainContainer(userName, displayName, profilePictureUrl) {
            // Ensure the sidebar is closed by default regardless of its previous state
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.remove('show');
            document.getElementById('mainContainer').classList.remove('with-sidebar');

            document.querySelector('.login-container').classList.add('hidden'); // Hide login card
            document.querySelector('.main-container').style.display = 'flex';    // Show dashboard

            // Show profile container
            document.getElementById('profileTrigger').style.display = 'flex';

            // Update and show the welcome message on the top-right
            document.getElementById('navDisplayName').innerText = "Hi " + displayName;

            // --- POPULATE DROPDOWN CONTENT ---
            document.getElementById('dropdownDisplayName').innerText = "Hi, " + displayName + "!";
            document.getElementById('dropdownUserEmail').innerText = userName;

            // --- NAVBAR AVATAR ---
            const navAvatarImg = document.getElementById('navUserAvatar');
            const navInitialsDiv = document.getElementById('navUserInitials');

            // --- DROPDOWN AVATAR ---
            const dropdownAvatarImg = document.getElementById('dropdownAvatar');
            const dropdownInitialsDiv = document.getElementById('dropdownInitials');

            // Helper to set either image or initials
            const setAvatar = (url, imgEl, initialsEl, isLarge = false) => {
                if (url && url.trim() !== "" && url !== "undefined") {
                    const directLink = getDriveDirectLink(url);
                    imgEl.src = directLink;
                    imgEl.style.display = 'block';
                    initialsEl.style.display = 'none';
                } else {
                    const firstLetter = displayName ? displayName.trim().charAt(0).toUpperCase() : "U";
                    imgEl.style.display = 'none';
                    initialsEl.innerText = firstLetter;
                    initialsEl.style.display = 'flex';
                }
            };

            setAvatar(profilePictureUrl, navAvatarImg, navInitialsDiv);
            setAvatar(profilePictureUrl, dropdownAvatarImg, dropdownInitialsDiv, true);


            // Show the burger (menu) icon
            document.getElementById('burger').style.display = 'block';

            // Now, force the global loader overlay to be visible (in case it was hidden)
            var loader = document.getElementById('globalLoader');
            loader.style.display = 'flex';  // Show overlay on top of dashboard
        }

        // Handle image load error specifically for dropdown
        function handleDropdownAvatarError() {
            const displayName = localStorage.getItem('displayName') || "U";
            const imgEl = document.getElementById('dropdownAvatar');
            const initialsEl = document.getElementById('dropdownInitials');

            imgEl.style.display = 'none';
            initialsEl.innerText = displayName.charAt(0).toUpperCase();
            initialsEl.style.display = 'flex';
        }

        // Handle image load error
        function handleAvatarError() {
            const displayName = localStorage.getItem('displayName') || "U";
            showInitialsAvatar(displayName);
        }

        // Show initials instead of image
        function showInitialsAvatar(name) {
            // This is now primarily used for the navbar fallback if triggered manually or by shared logic
            const avatarImg = document.getElementById('navUserAvatar');
            const initialsDiv = document.getElementById('navUserInitials');
            const firstLetter = name ? name.trim().charAt(0).toUpperCase() : "U";

            avatarImg.style.display = 'none';
            initialsDiv.innerText = firstLetter;
            initialsDiv.style.display = 'flex';
        }

        // Helper to convert Drive sharing link to direct download/view link
        function getDriveDirectLink(url) {
            if (!url) return '';
            const driveIdMatch = url.match(/[-\w]{25,}/);
            if (driveIdMatch && (url.includes('drive.google.com') || url.includes('docs.google.com'))) {
                return 'https://drive.google.com/thumbnail?id=' + driveIdMatch[0] + '&sz=w200';
            }
            return url;
        }

        // Show login screen if no user is logged in
        function showLoginContainer() {
            document.querySelector('.login-container').classList.remove('hidden');
            document.querySelector('.main-container').style.display = 'none';
        }

        // Build the sidebar dynamically with menu items
        function buildSidebar(filteredMenuStructure) {
            const sidebar = document.querySelector('.sidebar ul');
            sidebar.innerHTML = '';

            // 1) Sort main menu names alphabetically
            const sortedMainMenus = Object.keys(filteredMenuStructure).sort((a, b) => a.localeCompare(b));

            // 2) Loop over each sorted main menu
            for (let mainMenu of sortedMainMenus) {
                const li = document.createElement('li');
                li.innerHTML = `
                    <a href="#" onclick="event.preventDefault(); toggleSubMenu(this)">
                      <i class="fas fa-chevron-down"></i>${mainMenu}
                    </a>`;

                sidebar.appendChild(li);

                // Create the UL for sub‐menus
                const subMenuList = document.createElement('ul');
                subMenuList.className = 'submenu bg-[#5072A7]';

                // 3) Sort sub menus by the subMenu property (item.subMenu) alphabetically
                const sortedSubMenus = filteredMenuStructure[mainMenu].slice();

                // 4) Build each submenu item in alphabetical order
                sortedSubMenus.forEach(item => {
                    const subLi = document.createElement('li');
                    const subLink = `
                      <a href="#"
                        class="submenu-link"
                        onclick='event.preventDefault();
                                  loadSheet("${item.sheetName}",
                                            "${item.externalId}",
                                            "${item.subMenu}",
                                            "${item.rangeSpec}",
                                            "${userName}",
                                            "${item.dbLink}",
                                            ${JSON.stringify(item.buttons || [])},
                                            "${item.accessType || ''}")'>
                        ${safeString(item.subMenu)}
                      </a>`;

                    // If there’s a button link (item.btnName/item.btnLink), you can add it here
                    const buttonHtml = (item.btnName && item.btnLink)
                        ? `<button class="sidebar-btn" onclick="window.open('${item.btnLink}', '_blank')">
                          ${item.btnName}
                        </button>`
                        : '';

                    subLi.innerHTML = subLink + buttonHtml;
                    subMenuList.appendChild(subLi);
                });

                li.appendChild(subMenuList);
            }
        }

        // Toggle visibility of submenus when a main menu item is clicked
        function toggleSubMenu(element) {
            const submenu = element.nextElementSibling;
            submenu.style.display = submenu.style.display === 'block' ? 'none' : 'block'; // Toggle submenu visibility
        }

        /**
         * Extended loadSheet to also receive an array of buttons for this sub-menu
         */
        function loadSheet(sheetName, externalId, subMenuName, rangeSpec, userName, dbLink, buttons, accessType) {
            // Auto-collapse sidebar on selection
            const sidebar = document.getElementById('sidebar');
            if (sidebar && sidebar.classList.contains('show')) {
                sidebar.classList.remove('show');
                const mainContainer = document.getElementById('mainContainer');
                if (mainContainer) mainContainer.classList.remove('with-sidebar');
            }

            const linkContent = document.getElementById('linkContent');
            const sheetContent = document.getElementById('sheetContent');
            const globalLoader = document.getElementById('globalLoader');

            // Show loader at the start
            if (globalLoader) globalLoader.style.display = 'flex';

            // Clear any existing timers from other pages (e.g. ParamIndex.html)
            if (window.refreshTextTimeout) {
                clearTimeout(window.refreshTextTimeout);
                window.refreshTextTimeout = null;
            }
            // Add other potential timers if needed
            // if (window.refreshTimer) { clearInterval(window.refreshTimer); window.refreshTimer = null; }

            // Check if this is the User Management page (from dynamic menu)
            // Use strict comparison or check both potential sheet name and submenu name
            if (subMenuName === 'User Management' || sheetName === 'UserManagement') {
                loadUserManagement();
                return;
            }

            // Store the access type for future refreshes
            localStorage.setItem('currentSheetAccessType', accessType || "");

            // Check if this is the MIS Score page
            if (sheetName === 'MISScore' || subMenuName === 'MIS Score') {
                linkContent.style.display = 'none';
                sheetContent.style.display = 'block';

                google.script.run
                    .withSuccessHandler(function (returnedHtml) {
                        sheetContent.innerHTML = returnedHtml;

                        // Wait a brief moment for DOM to be ready, then initialize
                        setTimeout(function () {
                            // Evaluate any <script> tags inside the returned HTML
                            const scripts = sheetContent.querySelectorAll("script");
                            scripts.forEach(scr => {
                                try {
                                    eval(scr.innerHTML);
                                } catch (error) {
                                    console.error('Error evaluating MIS script:', error);
                                }
                            });

                            // Ensure Google Apps Script context is available and trigger initialization
                            if (typeof window.initializeMISPage === 'function') {
                                window.initializeMISPage();
                            }

                            if (globalLoader) globalLoader.style.display = 'none';
                        }, 100);
                    })
                    .withFailureHandler(function (err) {
                        console.error('Failed to load MIS Score page:', err);
                        sheetContent.innerHTML = '<div style="padding: 50px; text-align: center;"><h3>Error loading MIS Score page</h3><p>' + err + '</p></div>';
                        if (globalLoader) globalLoader.style.display = 'none';
                    })
                    .getMISScorePageHtml(userName, localStorage.getItem('role'));
                return;
            }

            // If dbLink is present, open it in the iframe. Otherwise, show ParamIndex
            if (dbLink && dbLink.trim() !== '') {
                linkContent.style.display = 'block';
                sheetContent.style.display = 'none';
                try {
                    new URL(dbLink);
                    document.getElementById('linkFrame').src = dbLink;
                } catch (err) {
                    document.getElementById('linkFrame').srcdoc = "<h3>Invalid link, can't open</h3>";
                }
                if (globalLoader) globalLoader.style.display = 'none';

            } else {
                linkContent.style.display = 'none';
                sheetContent.style.display = 'block';

                google.script.run
                    .withSuccessHandler(function (returnedHtml) {
                        sheetContent.innerHTML = returnedHtml;
                        // Evaluate any <script> tags inside the returned HTML
                        const scripts = sheetContent.querySelectorAll("script");
                        scripts.forEach(scr => eval(scr.innerHTML));
                        if (globalLoader) globalLoader.style.display = 'none';
                    })
                    .withFailureHandler(function (err) {
                        console.error(err);
                        if (globalLoader) globalLoader.style.display = 'none';
                    })
                    .getParamHtml(sheetName, subMenuName, externalId, rangeSpec, userName, localStorage.getItem('role'), buttons, accessType);
            }
        }

        function displaySheetData(response) {
            const sheetContent = document.getElementById('sheetContent');
            const loggedInUser = localStorage.getItem('userName');
            const role = localStorage.getItem('role');

            if (response.error) {
                sheetContent.innerHTML = `<p>${response.error}</p>`;
                return;
            }

            const data = response.data;
            if (!data || data.length === 0) {
                sheetContent.innerHTML = "<p>No data available.</p>";
                return;
            }

            let htmlContent = `
                      <div class="container flex flex-row justify-between gap-3 item-center">
                          <div style="margin-top: 10px">
                              <button style="background-color: #1F305E; margin-top: 5px;" class="btn text-white btn-reset border border-2 rounded" onclick="resetFilters()">Reset</button>
                          </div>
                          <div style="margin-top: 10px; display: none;">
                              <button style="background-color: #1F305E; margin-top: 5px;" class="btn text-white btn-reset border border-2 rounded" onclick="openLinkInNewTab()">Click</button>
                          </div>
                          <div class="d-flex flex-row font-bold text-xl">
                              <label for="searchBar" style="margin-right: 5px;">Search</label>
                              <input type="text" id="searchBar" style="border: 1px solid #1F305E;" class="form-control w-[300px]" placeholder="Search..." onkeyup="searchTable()">
                          </div>
                          <div>
                              <label class="" for="startDate">Start Date:</label>
                              <input type="date" id="startDate" onchange="filterByDateRange()">
                              <label class="" for="endDate">End Date:</label>
                              <input type="date" id="endDate" onchange="filterByDateRange()">
                          </div>
                      </div>
                      <div class="table-wrapper">
                          <table class="table2">
                              <thead>
                                  <tr>`;

            const uniqueValues = []; // To track unique dropdown options

            // Generate table headers
            data[0].forEach((cell, colIndex) => {
                htmlContent += `
                          <th>
                              ${cell}
                              <button onclick="sortTable(${colIndex}, 'asc')">▲</button>
                              <button onclick="sortTable(${colIndex}, 'desc')">▼</button>
                              <br>
                              <select class="filter-select w-full text-dark" id="filter-${colIndex}" onchange="filterDropdown(${colIndex})">
                                  <option value="">All</option>
                              </select>
                          </th>`;
                uniqueValues[colIndex] = new Set(); // Initialize unique values for each column
            });

            htmlContent += `</tr></thead>
                      <tbody class="table-body" id="tableBody">`;

            // Populate rows
            for (let i = 1; i < data.length; i++) {
                const rowUserName = data[i][0];
                if (role !== 'admin' && rowUserName !== loggedInUser) continue;

                htmlContent += "<tr>";
                data[i].forEach((cell, colIndex) => {
                    if (typeof cell === 'string' && cell.startsWith('http')) {
                        htmlContent += `
                                  <td>
                                      <button onclick="window.open('${cell}', '_blank')" style="background: none; border: none; color: blue; cursor: pointer;">
                                          <i class="fas fa-link"></i>
                                      </button>
                                  </td>`;
                    } else {
                        htmlContent += `<td>${cell}</td>`;
                        uniqueValues[colIndex].add(cell);
                    }
                });
                htmlContent += "</tr>";
            }

            htmlContent += `</tbody></table></div>
                  <footer class="footer mt-auto py-3 bg-light" style="border-top: 0.7px solid black; height: 50px;">
                      <div class="container d-flex justify-content-between align-items-center">
                          <div class="text-left">
                              <a href="https://www.businessautomations.in/" target="_blank" style="text-decoration: none; color: black; font-size: 15px; font-weight: 500;">Powered By @ Business Automations Solutions LLP</a>
                          </div>
                          <div class="footer-links d-flex align-items-center supportcontact">
                              <a href="https://your-contact-link.com" class="mx-2"><u>Contact</u></a>
                              <a href="https://your-support-link.com" class="mx-2"><u>Support</u></a>
                              <a href="tel:+918621893237" class="mx-2"><img src="https://img.icons8.com/?size=100&id=53439&format=png&color=000000" alt="Call" class="footer-icon"></a>
                              <a href="mailto:koushik.businessautomations@gmail.com" class="mx-2"><img src="https://img.icons8.com/?size=100&id=85500&format=png&color=000000" alt="Email" class="footer-icon"></a>
                              <a href="https://www.youtube.com/@businessautomations" class="mx-2"><img src="https://img.icons8.com/?size=100&id=19318&format=png&color=000000" alt="YouTube" class="footer-icon"></a>
                              <a href="https://www.linkedin.com/in/business-automations-solutions-llp-a80050203/" class="mx-2"><img src="https://img.icons8.com/?size=100&id=xuvGCOXi8Wyg&format=png&color=000000" alt="LinkedIn" class="footer-icon"></a>
                              <!-- Facebook Link -->
                              <a href="https://www.facebook.com/your-facebook-profile" class="mx-2"> <img src="https://img.icons8.com/?size=100&id=118497&format=png&color=000000" alt="Facebook" class="footer-icon"></a>
                              <!-- Instagram Link -->
                              <a href="https://www.instagram.com/your-instagram-profile" class="mx-2"><img src="https://img.icons8.com/?size=100&id=32292&format=png&color=000000" alt="Instagram" class="footer-icon"></a>
                          </div>
                      </div>
                  </footer>`;

            sheetContent.innerHTML = htmlContent;

            populateDropdownFilters(uniqueValues);
        }

        // Function to populate dropdown filters with unique values
        function populateDropdownFilters(uniqueValues) {
            uniqueValues.forEach((values, colIndex) => {
                const dropdown = document.getElementById(`filter-${colIndex}`);

                // Populate dropdown with unique values
                const sortedValues = Array.from(values).sort();
                sortedValues.forEach(value => {
                    const option = document.createElement('option');
                    option.value = value;
                    option.textContent = value;
                    dropdown.appendChild(option);
                });
            });
        }

        // Function to filter table rows based on selected dropdown options for all columns
        function filterTable() {
            const tableBody = document.getElementById('tableBody');
            const rows = tableBody.getElementsByTagName('tr');
            const numColumns = rows[0]?.getElementsByTagName('td').length || 0;

            const filters = [];
            for (let colIndex = 0; colIndex < numColumns; colIndex++) {
                const dropdown = document.getElementById(`filter-${colIndex}`);
                filters[colIndex] = dropdown.value;
            }

            // Show/hide rows based on all active filters
            for (let i = 0; i < rows.length; i++) {
                const cells = rows[i].getElementsByTagName('td');
                let rowMatches = true;

                for (let colIndex = 0; colIndex < numColumns; colIndex++) {
                    const cellValue = cells[colIndex]?.textContent || "";
                    if (filters[colIndex] && filters[colIndex] !== cellValue) {
                        rowMatches = false;
                        break;
                    }
                }

                rows[i].style.display = rowMatches ? "" : "none";
            }

            // Update dropdown options for visible rows only
            updateAllDropdowns();
        }

        // Function to update dropdown options based on visible rows
        function updateAllDropdowns() {
            const tableBody = document.getElementById('tableBody');
            const rows = tableBody.getElementsByTagName('tr');
            const numColumns = rows[0]?.getElementsByTagName('td').length || 0;

            for (let colIndex = 0; colIndex < numColumns; colIndex++) {
                const dropdown = document.getElementById(`filter-${colIndex}`);
                const currentValue = dropdown.value; // Save current selection
                const uniqueValues = new Set();

                // Collect unique visible values for this column
                for (let i = 0; i < rows.length; i++) {
                    if (rows[i].style.display === "none") continue;
                    const cellValue = rows[i].getElementsByTagName('td')[colIndex]?.textContent || "";
                    uniqueValues.add(cellValue);
                }

                // Repopulate dropdown options
                dropdown.innerHTML = '';
                const allOption = document.createElement('option');
                allOption.value = "";
                allOption.textContent = "All";
                dropdown.appendChild(allOption);

                const sortedValues = Array.from(uniqueValues).sort();
                sortedValues.forEach(value => {
                    const option = document.createElement('option');
                    option.value = value;
                    option.textContent = value;
                    dropdown.appendChild(option);
                });

                // Restore previously selected value if valid
                if ([...dropdown.options].some(option => option.value === currentValue)) {
                    dropdown.value = currentValue;
                }
            }
        }

        // Event listeners for each dropdown filter
        function filterDropdown(colIndex) {
            filterTable(); // Call the master filter function to apply all filters together
        }

        // Function to sort table by column (ascending or descending)
        function sortTable(colIndex, order) {
            const table = document.querySelector(".table2");
            const rows = Array.from(table.querySelectorAll("tbody tr"));

            rows.sort((a, b) => {
                const aText = a.querySelectorAll("td")[colIndex].textContent;
                const bText = b.querySelectorAll("td")[colIndex].textContent;

                return order === 'asc' ? aText.localeCompare(bText) : bText.localeCompare(aText);
            });

            const tbody = table.querySelector("tbody");
            rows.forEach(row => tbody.appendChild(row)); // Reorder rows in the table body
        }

        // Function to filter by date range dynamically across all columns
        function filterByDateRange() {
            const startDateInput = document.getElementById('startDate').value;
            const endDateInput = document.getElementById('endDate').value;
            const tableBody = document.getElementById('tableBody');
            const rows = tableBody.getElementsByTagName('tr');

            // Parse the input dates and set times explicitly
            let startDate = startDateInput ? new Date(startDateInput) : null;
            let endDate = endDateInput ? new Date(endDateInput) : null;
            if (startDate) startDate.setHours(0, 0, 0, 0);           // Start date at 00:00:00
            if (endDate) endDate.setHours(23, 59, 59, 999);           // End date at 23:59:59.999

            // Loop through each row in the table
            for (let i = 0; i < rows.length; i++) {
                let rowMatchesDateRange = false;
                const cells = rows[i].getElementsByTagName('td');
                for (let j = 0; j < cells.length; j++) {
                    const cellValue = cells[j].textContent.trim();
                    let rowDate;

                    // If the cell matches the "MM/dd/yyyy" pattern, use our helper
                    if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(cellValue)) {
                        rowDate = parseDateMMDDYYYY(cellValue);
                    } else {
                        rowDate = new Date(cellValue);
                    }

                    if (!isNaN(rowDate.getTime())) {
                        // Check if the row date is within the selected range.
                        // Entries on the start date (>= startDate) and on the end date (<= endDate) are included.
                        if ((startDate === null || rowDate >= startDate) &&
                            (endDate === null || rowDate <= endDate)) {
                            rowMatchesDateRange = true;
                            break; // No need to check further cells in this row
                        }
                    }
                }
                // Show or hide the row based on whether a matching date was found
                rows[i].style.display = rowMatchesDateRange ? "" : "none";
            }
        }

        // Function to reset all filters
        function resetFilters() {
            document.querySelectorAll('.filter-select').forEach(select => select.value = ""); // Reset dropdowns
            document.getElementById('startDate').value = ""; // Reset start date
            document.getElementById('endDate').value = ""; // Reset end date
            document.getElementById('searchBar').value = ""; // Reset search bar

            const rows = document.getElementById('tableBody').getElementsByTagName('tr');
            for (let i = 0; i < rows.length; i++) {
                rows[i].style.display = ""; // Show all rows
            }

            $('.filter-select').val(null).trigger('change');
        }

        // Load homepage content after login
        function loadHomePage() {
            // Get the metrics visibility flag from localStorage
            const metricsVisible = localStorage.getItem('metricsVisible') === 'true';

            // Make sure to hide the iframe container and show the dashboard content
            document.getElementById('linkContent').style.display = 'none';
            document.getElementById('sheetContent').style.display = 'block';

            document.getElementById('globalLoader').style.display = 'flex';

            // 1) Insert the dashboard HTML first, so the DOM has the containers:
            document.getElementById('sheetContent').innerHTML = `
                    <section class="container mt-3">
                      <div class="row g-3">
                          <div class="col-md-3 col-sm-6">
                              <div class="stat-card primary p-3">
                                  <div class="stat-card-content">
                                      <div class="stat-card-info">
                                          <h5>Total Tasks</h5>
                                          <p id="total-tasks">Loading...</p>
                                      </div>
                                      <div class="stat-card-icon"><i class="fa-solid fa-list"></i></div>
                                  </div>
                              </div>
                          </div>
                          <div class="col-md-3 col-sm-6">
                              <div class="stat-card danger p-3">
                                  <div class="stat-card-content">
                                      <div class="stat-card-info">
                                          <h5>Overdue Tasks</h5>
                                          <p id="overdue-tasks">Loading...</p>
                                      </div>
                                      <div class="stat-card-icon"><i class="fa-solid fa-triangle-exclamation"></i></div>
                                  </div>
                              </div>
                          </div>
                          <div class="col-md-3 col-sm-6">
                              <div class="stat-card warning p-3">
                                  <div class="stat-card-content">
                                      <div class="stat-card-info">
                                          <h5>Upcoming Tasks</h5>
                                          <p id="upcoming-tasks">Loading...</p>
                                      </div>
                                      <div class="stat-card-icon" style="color:#1f2937;"><i class="fa-solid fa-clock"></i></div>
                                  </div>
                              </div>
                          </div>
                          <div class="col-md-3 col-sm-6">
                              <div class="stat-card success p-3">
                                  <div class="stat-card-content">
                                      <div class="stat-card-info">
                                          <h5>Today Task</h5>
                                          <p id="today-tasks">Loading...</p>
                                      </div>
                                      <div class="stat-card-icon"><i class="fa-solid fa-check"></i></div>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </section>

                  <section class="container py-3">
                      <button type="button" class="btn btn-secondary mb-3 d-none" style="margin-top: 12px;" id="resetFilters">Reset Filters</button>
                      <div class="row filter-section" style="margin-top: 8px;">
                          <div class="col-md-4 mb-3">
                              <label for="doerFilter" class="form-label">Filter by Doer Name:</label>
                              <select id="doerFilter" style='border: none; box-shadow: 0 0 4px rgba(31, 48, 94, 0.4);' class="form-select">
                                  <option value="">All</option>
                              </select>
                          </div>
                          <div class="col-md-4 mb-3">
                              <label for="processFilter" class="form-label">Filter by Process Name:</label>
                              <select id="processFilter" style='border: none; box-shadow: 0 0 4px rgba(31, 48, 94, 0.4);' class="form-select">
                                  <option value="">All</option>
                              </select>
                          </div>
                          <div class="col-md-4 mb-3">
                              <label for="statusFilter" class="form-label">Filter by Status:</label>
                              <select id="statusFilter" style='border: none; box-shadow: 0 0 4px rgba(31, 48, 94, 0.4);' class="form-select">
                                  <option value="">All</option>
                              </select>
                          </div>
                      </div>
                      <div class="row filter-section">
                          <div class="col-md-4 mb-3">
                              <label for="startDate" class="form-label">Start Date:</label>
                              <input type="date" style='border: none; box-shadow: 0 0 4px rgba(31, 48, 94, 0.4);' id="startDate" class="form-control mb-2">
                          </div>
                          <div class="col-md-4 mb-3">
                              <label for="endDate" class="form-label">End Date:</label>
                              <input type="date" id="endDate" style='border: none; box-shadow: 0 0 4px rgba(31, 48, 94, 0.4);' class="form-control mb-2">
                          </div>
                          <div class="col-md-4 d-flex flex-row gap-3" style="margin-top: 25px; height: 50%;">
                              <button type="button" id="applyDateRange" class="btn btn-primary">Apply</button>
                              <button type="button" id="resetDateRange" class="btn btn-secondary">Reset Date Range</button>
                              <button type="button" id="resetAllFilters" class="btn btn-danger">Reset All Filters</button>
                          </div>
                  </section>
                  
                  ${metricsVisible ? `
                  <section class="container my-4">
                    <div class="row g-4 mb-4">
                      <div class="col-lg-6">
                        <div class="card shadow-sm" onclick="openEnlargedGraph('bar_chart_div', 'barChart', window.myBarChart1Data, window.myBarChart1Options)">
                          <div class="card-body"><div id="bar_chart_div"></div></div>
                        </div>
                      </div>
                      <div class="col-lg-6">
                        <div class="card shadow-sm" onclick="openEnlargedGraph('pie_chart_div', 'pieChart', window.myPieChart1Data, window.myPieChart1Options)">
                          <div class="card-body"><div id="pie_chart_div"></div></div>
                        </div>
                      </div>
                    </div>
                    <div class="row g-4">
                      <div class="col-lg-6">
                        <div class="card shadow-sm" onclick="openEnlargedGraph('bar_chart_div2', 'barChart', window.myBarChart2Data, window.myBarChart2Options)">
                          <div class="card-body"><div id="bar_chart_div2"></div></div>
                        </div>
                      </div>
                      <div class="col-lg-6">
                        <div class="card shadow-sm" onclick="openEnlargedGraph('pie_chart_div2', 'barChart', window.myBarChart3Data, window.myBarChart3Options)">
                          <div class="card-body"><div id="pie_chart_div2"></div></div>
                        </div>
                      </div>
                    </div>
                  </section>
                  ` : ''}
            
                    <!-- MIS Score Section -->
                    <section class="container my-4" id="misScoreSection" style="display: none;">
                      <div class="row mb-3">
                        <div class="col-12">
                          <h3 class="text-left mb-3" style="color: #1A7499; font-weight: bold;">Score Management</h3>
                          
                          <!-- Tab Navigation -->
                          <ul class="nav nav-tabs mb-3" id="scoreManagementTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                              <button class="nav-link active" id="mis-tab" data-bs-toggle="tab" data-bs-target="#mis-tab-pane" type="button" role="tab" aria-controls="mis-tab-pane" aria-selected="true" onclick="switchScoreTab('mis')">MIS Score</button>
                            </li>
                            <li class="nav-item" role="presentation">
                              <button class="nav-link" id="delegation-tab" data-bs-toggle="tab" data-bs-target="#delegation-tab-pane" type="button" role="tab" aria-controls="delegation-tab-pane" aria-selected="false" onclick="switchScoreTab('delegation')">Delegation</button>
                            </li>
                          </ul>
                          
                          <!-- Common Filters -->
                          <div class="filter-section" style="padding: 15px;">
                            <div class="row align-items-end">
                              <div class="col-md-2">
                                <label for="scoreStartDate" class="form-label">Start Date:</label>
                                <input type="date" id="scoreStartDate" class="form-control" style="border: 1px solid #1F305E;">
                              </div>
                              <div class="col-md-2">
                                <label for="scoreEndDate" class="form-label">End Date:</label>
                                <input type="date" id="scoreEndDate" class="form-control" style="border: 1px solid #1F305E;" readonly>
                              </div>
                              <div class="col-md-2">
                                <label for="scoreWeekNumber" class="form-label">Week Number:</label>
                                <select id="scoreWeekNumber" class="form-select" style="border: 1px solid #1F305E; max-height: 200px; overflow-y: auto;">
                                  <option value="">Select Week...</option>
                                </select>
                              </div>
                              <div class="col-md-2" id="scoreUserFilterContainer" style="display: none;">
                                <label for="scoreUserFilter" class="form-label">Users:</label>
                                <div class="dropdown">
                                  <button class="btn btn-outline-secondary dropdown-toggle w-100" type="button" id="scoreUserFilterBtn" data-bs-toggle="dropdown" aria-expanded="false" style="border: 1px solid #1F305E; text-align: left;">
                                    All Users
                                  </button>
                                  <div class="dropdown-menu w-100 p-2" aria-labelledby="scoreUserFilterBtn" id="scoreUserDropdown" style="max-height: 300px; overflow-y: auto;">
                                    <input type="text" class="form-control mb-2" id="scoreUserSearch" placeholder="Search users...">
                                    <div id="scoreUserCheckboxes">
                                      <!-- User checkboxes will be populated here -->
                                    </div>
                                    <hr class="my-2">
                                    <button type="button" class="btn btn-sm btn-outline-primary me-1" onclick="selectAllScoreUsers()">Select All</button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearAllScoreUsers()">Clear All</button>
                                  </div>
                                </div>
                              </div>
                              <div class="col-md-4">
                                <button id="refreshScoreBtn" class="btn btn-primary" style="background-color: #1A7499; border-color: #1A7499;">Refresh</button>
                                <button id="resetScoreBtn" class="btn btn-secondary ms-2" style="background-color: #6c757d; border-color: #6c757d;">Reset</button>
                              </div>
                            </div>
                          </div>
            
                          <!-- Tab Content -->
                          <div class="tab-content" id="scoreManagementTabContent">
                            <!-- MIS Score Tab -->
                            <div class="tab-pane fade show active" id="mis-tab-pane" role="tabpanel" aria-labelledby="mis-tab">
                              <div class="table-responsive" style="max-height: 70vh; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 8px;">
                                <table class="table table-striped table-bordered" id="misTable">
                                  <thead class="table-light">
                                    <tr>
                                      <th rowspan="2" style="position: sticky; top: 0; background: #1A7499; color: white; z-index: 12; vertical-align: middle; border: 1px solid #dee2e6;">User ID</th>
                                      <th rowspan="2" style="position: sticky; top: 0; background: #1A7499; color: white; z-index: 12; vertical-align: middle; border: 1px solid #dee2e6;">Name</th>
                                      <th colspan="5" style="position: sticky; top: 0; background: #2c5f8a; color: white; z-index: 12; text-align: center; border: 1px solid #dee2e6;">Work Not Done</th>
                                      <th colspan="5" style="position: sticky; top: 0; background: #2c5f8a; color: white; z-index: 12; text-align: center; border: 1px solid #dee2e6;">Work Done on Time</th>
                                      <th rowspan="2" style="position: sticky; top: 0; background: #1A7499; color: white; z-index: 12; vertical-align: middle; border: 1px solid #dee2e6;">Action</th>
                                    </tr>
                                    <tr>
                                      <th style="position: sticky; top: 40px; background: #1A7499; color: white; z-index: 11; border: 1px solid #dee2e6; font-size: 12px; vertical-align: middle; text-align: center;">Current Week<br>Score (WND)</th>
                                      <th style="position: sticky; top: 40px; background: #1A7499; color: white; z-index: 11; border: 1px solid #dee2e6; font-size: 12px; vertical-align: middle; text-align: center;">Total Task</th>
                                      <th style="position: sticky; top: 40px; background: #1A7499; color: white; z-index: 11; border: 1px solid #dee2e6; font-size: 12px; vertical-align: middle; text-align: center;">Total Completed<br>Task</th>
                                      <th style="position: sticky; top: 40px; background: #1A7499; color: white; z-index: 11; border: 1px solid #dee2e6; font-size: 12px; vertical-align: middle; text-align: center;">Score</th>
                                      <th style="position: sticky; top: 40px; background: #1A7499; color: white; z-index: 11; border: 1px solid #dee2e6; font-size: 12px; vertical-align: middle; text-align: center;">Next Commitment</th>
                                      <th style="position: sticky; top: 40px; background: #1A7499; color: white; z-index: 11; border: 1px solid #dee2e6; font-size: 12px; vertical-align: middle; text-align: center;">Current Week<br>Score (WND-OT)</th>
                                      <th style="position: sticky; top: 40px; background: #1A7499; color: white; z-index: 11; border: 1px solid #dee2e6; font-size: 12px; vertical-align: middle; text-align: center;">Total Complete<br>Task</th>
                                      <th style="position: sticky; top: 40px; background: #1A7499; color: white; z-index: 11; border: 1px solid #dee2e6; font-size: 12px; vertical-align: middle; text-align: center;">On Time Done<br>Task</th>
                                      <th style="position: sticky; top: 40px; background: #1A7499; color: white; z-index: 11; border: 1px solid #dee2e6; font-size: 12px; vertical-align: middle; text-align: center;">Score</th>
                                      <th style="position: sticky; top: 40px; background: #1A7499; color: white; z-index: 11; border: 1px solid #dee2e6; font-size: 12px; vertical-align: middle; text-align: center;">Next Commitment</th>
                                    </tr>
                                  </thead>
                                  <tbody id="misTableBody">
                                    <tr>
                                      <td colspan="12" class="text-center">Please select a date range to view MIS data</td>
                                    </tr>
                                  </tbody>
                                </table>
                              </div>
                            </div>
            
                            <!-- Delegation Tab -->
                            <div class="tab-pane fade" id="delegation-tab-pane" role="tabpanel" aria-labelledby="delegation-tab">
                              <div class="table-responsive" style="max-height: 70vh; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 8px;">
                                <table class="table table-striped table-bordered" id="delegationTable">
                                  <thead class="table-light">
                                    <tr>
                                      <th rowspan="2" style="position: sticky; top: 0; background: #1A7499; color: white; z-index: 12; vertical-align: middle; border: 1px solid #dee2e6;">Email</th>
                                      <th rowspan="2" style="position: sticky; top: 0; background: #1A7499; color: white; z-index: 12; vertical-align: middle; border: 1px solid #dee2e6;">Name</th>
                                      <th colspan="3" style="position: sticky; top: 0; background: #2c5f8a; color: white; z-index: 12; text-align: center; border: 1px solid #dee2e6;">Current Planned</th>
                                      <th colspan="3" style="position: sticky; top: 0; background: #2c5f8a; color: white; z-index: 12; text-align: center; border: 1px solid #dee2e6;">Current Score</th>
                                      <th colspan="4" style="position: sticky; top: 0; background: #2c5f8a; color: white; z-index: 12; text-align: center; border: 1px solid #dee2e6;">Total Task Details</th>
                                      <th colspan="3" style="position: sticky; top: 0; background: #2c5f8a; color: white; z-index: 12; text-align: center; border: 1px solid #dee2e6;">Next Committed</th>
                                    </tr>
                                    <tr>
                                      <th style="position: sticky; top: 40px; background: #dc3545; color: white; z-index: 11; border: 1px solid #dee2e6; font-size: 12px; vertical-align: middle; text-align: center;">Red Score</th>
                                      <th style="position: sticky; top: 40px; background: #ffc107; color: black; z-index: 11; border: 1px solid #dee2e6; font-size: 12px; vertical-align: middle; text-align: center;">Yellow Score</th>
                                      <th style="position: sticky; top: 40px; background: #28a745; color: white; z-index: 11; border: 1px solid #dee2e6; font-size: 12px; vertical-align: middle; text-align: center;">Green Score</th>
                                      <th style="position: sticky; top: 40px; background: #dc3545; color: white; z-index: 11; border: 1px solid #dee2e6; font-size: 12px; vertical-align: middle; text-align: center;">Red Score</th>
                                      <th style="position: sticky; top: 40px; background: #ffc107; color: black; z-index: 11; border: 1px solid #dee2e6; font-size: 12px; vertical-align: middle; text-align: center;">Yellow Score</th>
                                      <th style="position: sticky; top: 40px; background: #28a745; color: white; z-index: 11; border: 1px solid #dee2e6; font-size: 12px; vertical-align: middle; text-align: center;">Green Score</th>
                                      <th style="position: sticky; top: 40px; background: #1A7499; color: white; z-index: 11; border: 1px solid #dee2e6; font-size: 12px; vertical-align: middle; text-align: center;">Total Task</th>
                                      <th style="position: sticky; top: 40px; background: #1A7499; color: white; z-index: 11; border: 1px solid #dee2e6; font-size: 12px; vertical-align: middle; text-align: center;">Completed Task</th>
                                      <th style="position: sticky; top: 40px; background: #1A7499; color: white; z-index: 11; border: 1px solid #dee2e6; font-size: 12px; vertical-align: middle; text-align: center;">Pending Task</th>
                                      <th style="position: sticky; top: 40px; background: #1A7499; color: white; z-index: 11; border: 1px solid #dee2e6; font-size: 12px; vertical-align: middle; text-align: center;">Shifted Task</th>
                                      <th style="position: sticky; top: 40px; background: #dc3545; color: white; z-index: 11; border: 1px solid #dee2e6; font-size: 12px; vertical-align: middle; text-align: center;">Red Score</th>
                                      <th style="position: sticky; top: 40px; background: #ffc107; color: black; z-index: 11; border: 1px solid #dee2e6; font-size: 12px; vertical-align: middle; text-align: center;">Yellow Score</th>
                                      <th style="position: sticky; top: 40px; background: #28a745; color: white; z-index: 11; border: 1px solid #dee2e6; font-size: 12px; vertical-align: middle; text-align: center;">Green Score</th>
                                    </tr>
                                  </thead>
                                  <tbody id="delegationTableBody">
                                    <tr>
                                      <td colspan="15" class="text-center">Please select a date range to view delegation data</td>
                                    </tr>
                                  </tbody>
                                </table>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </section>
            
                    <!-- MIS Process Details Modal -->
                    <div id="misProcessModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 10000; justify-content: center; align-items: center;">
                      <div style="background: white; border-radius: 8px; padding: 20px; width: 90%; max-width: 1000px; max-height: 80vh; overflow-y: auto; position: relative;">
                        <button onclick="closeMisProcessModal()" style="position: absolute; top: 10px; right: 15px; font-size: 24px; background: none; border: none; cursor: pointer; color: #777;">&times;</button>
                        <div style="border-bottom: 2px solid #dee2e6; padding-bottom: 10px; margin-bottom: 20px;">
                          <h4 id="misModalTitle">Process Details</h4>
                          <p id="misModalSubtitle" style="color: #777; margin-bottom: 0;"></p>
                        </div>
                        <div id="misProcessTableContainer">
                          <!-- Process table will be populated here -->
                        </div>
                      </div>
                    </div>
            
                    <div style="display: none;">
                        <!-- Some hidden tables ... -->
                    </div>
                    <!-- Table Section -->
          <section class="container my-4">
            <div class="table-responsive" style="height: 400px; overflow-y: auto;">
                            <h2 class="text-left mb-4 fs-4 fw-bold">Process Wise Task Details</h2>
                            <table class="table table-striped table-bordered">
                                <thead class="table-light">
                                    <tr>
                    <th style="position: sticky; top: 0; background: #3498db; color: white; z-index: 1;">Step/Task Name</th>
                    <th style="position: sticky; top: 0; background: #3498db; color: white; z-index: 1;">Doer Name</th>
                    <th style="position: sticky; top: 0; background: #3498db; color: white; z-index: 1;">Process Name</th>
                    <th style="position: sticky; top: 0; background: #3498db; color: white; z-index: 1;">Planned</th>
                    <th style="position: sticky; top: 0; background: #3498db; color: white; z-index: 1;">Done</th>
                    <th style="position: sticky; top: 0; background: #3498db; color: white; z-index: 1;">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="data-table"></tbody>
                            </table>
            </div>
          </section>
                    <footer class="footer mt-auto py-3 bg-light" style="border-top: 0.7px solid black; height: 50px; margin-top: 10px">
                        <!-- your footer -->
                    </footer>
                  `;

            // 2) Conditionally load charts and fetch data
            if (metricsVisible) {
                google.charts.load('current', { packages: ['corechart'] });
                google.charts.setOnLoadCallback(fetchData);
            } else {
                // If metrics are hidden, just fetch data for the main table and filters
                google.script.run.withSuccessHandler(function (data) {
                    processData(data); // This function will now handle both cases
                    document.getElementById('globalLoader').style.display = 'none';
                }).getSheetData2();
            }

            // 3) Fetch data from server
            function fetchData() {
                google.script.run.withSuccessHandler(function (data) {
                    processData(data);
                    document.getElementById('globalLoader').style.display = 'none';
                }).getSheetData2();
            }

            // 4) Process data
            function processData(data) {
                // IMPORTANT: define both user & role here so they're in scope on first load
                const loggedInUser = localStorage.getItem('userName');
                const loggedInRole = localStorage.getItem('role');

                // Update Cards - This now runs regardless of metricsVisible
                const totalTasks = data.length - 1; // Exclude headers
                document.getElementById('total-tasks').innerText = totalTasks;

                const overdueTasks = data.filter(row => row[6] === 'Over Due').length;
                document.getElementById('overdue-tasks').innerText = overdueTasks;

                const upcomingTasks = data.filter(row => row[6] === 'Up-Comming').length;
                document.getElementById('upcoming-tasks').innerText = upcomingTasks;

                const todayTasks = data.filter(row => row[6] === 'Today').length;
                document.getElementById('today-tasks').innerText = todayTasks;

                // Filter elements
                const doerFilter = document.getElementById('doerFilter');
                const processFilter = document.getElementById('processFilter');
                const statusFilter = document.getElementById('statusFilter');
                const resetButton = document.getElementById('resetFilters');
                const resetDateRangeButton = document.getElementById('resetDateRange');
                const resetAllFiltersButton = document.getElementById('resetAllFilters');
                const tableBody = document.getElementById('data-table');

                // Clear previous options
                doerFilter.innerHTML = '<option value="">All</option>';
                processFilter.innerHTML = '<option value="">All</option>';
                statusFilter.innerHTML = '<option value="">All</option>';

                // Extract unique values for filters
                const doerNames = [...new Set(data.slice(1).map(row => row[1]))];
                const processNames = [...new Set(data.slice(1).map(row => row[2]))];
                const statuses = [...new Set(data.slice(1).map(row => row[6]))];

                // Populate filter dropdowns
                doerNames.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    doerFilter.appendChild(option);
                });
                processNames.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    processFilter.appendChild(option);
                });
                statuses.forEach(status => {
                    const option = document.createElement('option');
                    option.value = status;
                    option.textContent = status;
                    statusFilter.appendChild(option);
                });

                // Attach event listeners to trigger filtering when dropdown values change
                doerFilter.addEventListener('change', function () {
                    renderTable(data);
                });
                processFilter.addEventListener('change', function () {
                    renderTable(data);
                });
                statusFilter.addEventListener('change', function () {
                    renderTable(data);
                });

                // Attach event listener to the "Apply" button for date range filtering
                document.getElementById('applyDateRange').addEventListener('click', function () {
                    renderTable(data);
                });

                // (Optional) Also filter as soon as the dates change:
                document.getElementById('startDate').addEventListener('change', function () {
                    renderTable(data);
                });
                document.getElementById('endDate').addEventListener('change', function () {
                    renderTable(data);
                });

                // Reset Filters
                resetButton.addEventListener('click', function () {
                    doerFilter.value = "";
                    processFilter.value = "";
                    statusFilter.value = "";
                    document.getElementById('startDate').value = "";
                    document.getElementById('endDate').value = "";

                    renderTable(data);
                });

                resetDateRangeButton.addEventListener('click', function () {
                    document.getElementById('startDate').value = "";
                    document.getElementById('endDate').value = "";
                    renderTable(data);
                });

                resetAllFiltersButton.addEventListener('click', function () {
                    doerFilter.value = "";
                    processFilter.value = "";
                    statusFilter.value = "";
                    document.getElementById('startDate').value = "";
                    document.getElementById('endDate').value = "";

                    renderTable(data);
                });

                function parseDateMMDDYYYY(dateStr) {
                    // Splits a date string in MM/dd/yyyy format and returns a Date object set to midnight.
                    var parts = dateStr.split('/');
                    var d = new Date(parts[2], parts[0] - 1, parts[1]);
                    d.setHours(0, 0, 0, 0);
                    return d;
                }

                // Define the function that renders the table
                function renderTable(data) {
                    const doerValue = doerFilter.value;
                    const processValue = processFilter.value;
                    const statusValue = statusFilter.value;
                    // Retrieve date filter values from the input fields
                    const startDateValue = document.getElementById('startDate').value;
                    const endDateValue = document.getElementById('endDate').value;

                    // Convert the input dates to Date objects; adjust end date to include the entire day.
                    let start = startDateValue ? new Date(startDateValue) : null;
                    let end = endDateValue ? new Date(endDateValue) : null;

                    // Subtract one day from the start date to ensure that entries on the start date are included
                    if (start) {
                        start = new Date(start.getTime() - 86400000); // 86,400,000 ms = 1 day
                        start.setHours(0, 0, 0, 0);
                    }

                    if (end) {
                        end.setHours(23, 59, 59, 999);
                    }

                    // Filter data using the parsed dashboard date.
                    const filteredData = data.slice(1).filter(row => {
                        // Parse the row date using our helper function.
                        const rowDate = parseDateMMDDYYYY(row[3]);
                        const inRange = (!start || rowDate >= start) && (!end || rowDate <= end);

                        // Existing conditions for filtering based on role and other filters.
                        if (loggedInRole === 'user') {
                            return (
                                row[0] === loggedInUser &&
                                (doerValue === '' || row[1] === doerValue) &&
                                (processValue === '' || row[2] === processValue) &&
                                (statusValue === '' || row[6] === statusValue) &&
                                inRange
                            );
                        } else {
                            return (
                                (doerValue === '' || row[1] === doerValue) &&
                                (processValue === '' || row[2] === processValue) &&
                                (statusValue === '' || row[6] === statusValue) &&
                                inRange
                            );
                        }
                    });

                    // Render the table
                    tableBody.innerHTML = filteredData.length
                        ? filteredData.map(row => `
                                  <tr>
                                    <td>${row[4]}</td>
                                    <td>${row[1]}</td>
                                    <td>${row[2]}</td>
                                    <td>${row[3]}</td>
                                    <td>
                                      <a href="${row[5]}" class="btn btn-primary" target="_blank" rel="noopener noreferrer">
                                        <i class="fa-solid fa-arrow-up-right-from-square"></i>
                                      </a>
                                    </td>
                                    <td>${row[6]}</td>
                                  </tr>
                                `).join('')
                        : '<tr><td colspan="6">No data available for the selected filters.</td></tr>';

                    // Update card counts - This now runs regardless of metricsVisible
                    document.getElementById('total-tasks').innerText = filteredData.length;
                    document.getElementById('overdue-tasks').innerText = filteredData.filter(r => r[6] === 'Over Due').length;
                    document.getElementById('upcoming-tasks').innerText = filteredData.filter(r => r[6] === 'Up-Comming').length;
                    document.getElementById('today-tasks').innerText = filteredData.filter(r => r[6] === 'Today').length;

                    // This part remains conditional
                    if (metricsVisible) {
                        // Update charts with the newly filtered data
                        updateCharts(filteredData);
                    }

                    updateDashboardFilters(filteredData);

                }

                function updateDashboardFilters(filteredData) {
                    // Get the dashboard filter dropdown elements
                    const doerFilter = document.getElementById('doerFilter');
                    const processFilter = document.getElementById('processFilter');
                    const statusFilter = document.getElementById('statusFilter');

                    // Save current selections so you can restore them if still valid
                    const currentDoer = doerFilter.value;
                    const currentProcess = processFilter.value;
                    const currentStatus = statusFilter.value;

                    // Clear existing options and add the "All" default option
                    doerFilter.innerHTML = '<option value="">All</option>';
                    processFilter.innerHTML = '<option value="">All</option>';
                    statusFilter.innerHTML = '<option value="">All</option>';

                    // Extract unique values from the filtered data (assuming row[1]=Doer, row[2]=Process, row[6]=Status)
                    const doers = Array.from(new Set(filteredData.map(row => row[1]))).sort();
                    const processes = Array.from(new Set(filteredData.map(row => row[2]))).sort();
                    const statuses = Array.from(new Set(filteredData.map(row => row[6]))).sort();

                    // Populate the dropdowns with the new options
                    doers.forEach(val => {
                        const option = document.createElement('option');
                        option.value = val;
                        option.textContent = val;
                        doerFilter.appendChild(option);
                    });

                    processes.forEach(val => {
                        const option = document.createElement('option');
                        option.value = val;
                        option.textContent = val;
                        processFilter.appendChild(option);
                    });

                    statuses.forEach(val => {
                        const option = document.createElement('option');
                        option.value = val;
                        option.textContent = val;
                        statusFilter.appendChild(option);
                    });

                    // Restore the previous selections if they still exist in the filtered options
                    if (doers.includes(currentDoer)) {
                        doerFilter.value = currentDoer;
                    }
                    if (processes.includes(currentProcess)) {
                        processFilter.value = currentProcess;
                    }
                    if (statuses.includes(currentStatus)) {
                        statusFilter.value = currentStatus;
                    }
                }


                // Finally, render the main data table
                renderTable(data);

                // Now, initialize the sections that depend on the data being processed
                if (metricsVisible) {
                    drawCharts(data); // Draw charts only if they are visible
                }

                // Always initialize the MIS score section, as it's always visible
                initializeMisScore();
            }

            // Utility function to open link in new tab
            function done(link) {
                window.open(link, '_blank');
            }

            // 5) Charting functions
            function drawCharts(data) {
                const taskCounts = {};
                const statusCounts = {};
                const doerCounts = {};

                data.slice(1).forEach(row => {
                    const process = row[2];
                    const doer = row[1];
                    const status = row[6];
                    doerCounts[doer] = (doerCounts[doer] || 0) + 1;
                    taskCounts[process] = (taskCounts[process] || 0) + 1;
                    statusCounts[status] = (statusCounts[status] || 0) + 1;
                });

                drawBarChart(taskCounts);
                drawPieChart(statusCounts);
                drawBarChart2(doerCounts);
                drawBarChart3(statusCounts);
            }

            //------------------------------------------------
            // 1) "Process-Wise Task Count"  (bar_chart_div)
            //------------------------------------------------
            function drawBarChart(taskCounts) {
                // Build array for Google Charts
                const chartData = [
                    ['Process', 'Count', { role: 'style' }, { role: 'annotation' }]
                ];

                if (Object.keys(taskCounts).length === 0) {
                    chartData.push(["No Data", 0, 'color: #3498db', 0]);
                } else {
                    Object.entries(taskCounts).forEach(([process, count]) => {
                        chartData.push([process, Number(count), 'color: #3498db', Number(count)]);
                    });
                }

                // Convert array to DataTable
                const dataTable = google.visualization.arrayToDataTable(chartData);

                // Chart options
                const options = {
                    title: "Process-Wise Task Count (Columns Chart)",
                    legend: { position: 'none' },
                    annotations: {
                        alwaysOutside: true,
                        textStyle: { fontSize: 12, color: '#000' }
                    }
                };

                // Create the chart object
                const chart = new google.visualization.ColumnChart(
                    document.getElementById('bar_chart_div')
                );

                // Draw the chart
                chart.draw(dataTable, options);

                // Store references globally, so we can re-draw later
                window.myBarChart1 = chart;          // Chart object
                window.myBarChart1Data = dataTable;  // Chart data
                window.myBarChart1Options = options; // Chart options
            }


            //------------------------------------------------
            // 2) "Process-Wise Status Breakdown" (pie_chart_div)
            //------------------------------------------------
            function drawPieChart(statusCounts) {
                const chartData = [['Status', 'Count']];
                // We'll define slices so we can force Over Due / Up-Comming / Today colors
                const slices = {};
                let rowIndex = 0;

                if (Object.keys(statusCounts).length === 0) {
                    chartData.push(["No Data", 0]);
                } else {
                    Object.entries(statusCounts).forEach(([status, count]) => {
                        chartData.push([status, Number(count)]);

                        // Color each status consistently:
                        if (status === 'Over Due') {
                            slices[rowIndex] = { color: '#e74c3c' };  // Red
                        } else if (status === 'Up-Comming') {
                            slices[rowIndex] = { color: '#91830d' };  // Brownish
                        } else if (status === 'Today') {
                            slices[rowIndex] = { color: '#27ae60' };  // Green
                        }
                        rowIndex++;
                    });
                }

                const dataTable = google.visualization.arrayToDataTable(chartData);
                const options = {
                    title: "Process-Wise Status Breakdown (Pie Chart)",
                    slices: slices
                };

                const chart = new google.visualization.PieChart(
                    document.getElementById('pie_chart_div')
                );
                chart.draw(dataTable, options);

                // Store references if needed
                window.myPieChart1 = chart;
                window.myPieChart1Data = dataTable;
                window.myPieChart1Options = options;
            }

            //------------------------------------------------
            // 3) "Doer-Wise Task Count" (bar_chart_div2)
            //------------------------------------------------
            function drawBarChart2(doerCounts) {
                const chartData = [
                    ['Doer', 'Count', { role: 'style' }, { role: 'annotation' }]
                ];

                if (Object.keys(doerCounts).length === 0) {
                    chartData.push(["No Data", 0, 'color: #3498db', 0]);
                } else {
                    Object.entries(doerCounts).forEach(([doer, count]) => {
                        chartData.push([doer, Number(count), 'color: #3498db', Number(count)]);
                    });
                }

                const dataTable = google.visualization.arrayToDataTable(chartData);
                const options = {
                    title: "Doer-Wise Task Count (Columns Chart)",
                    legend: { position: 'none' },
                    chartArea: { width: '70%', left: '15%' },
                    annotations: {
                        alwaysOutside: true,
                        textStyle: { fontSize: 12, color: '#000' }
                    },
                    hAxis: { title: 'Count' },
                    vAxis: { title: 'Doer' }
                };

                const chart = new google.visualization.ColumnChart(
                    document.getElementById('bar_chart_div2')
                );
                chart.draw(dataTable, options);

                // Store references
                window.myBarChart2 = chart;
                window.myBarChart2Data = dataTable;
                window.myBarChart2Options = options;
            }


            //------------------------------------------------
            // 4) "Doer-Wise Status Count" (pie_chart_div2)
            //    Actually it's a ColumnChart in your code
            //------------------------------------------------
            function drawBarChart3(statusCounts) {
                const chartData = [
                    ['Status', 'Count', { role: 'style' }, { role: 'annotation' }]
                ];

                if (Object.keys(statusCounts).length === 0) {
                    chartData.push(["No Data", 0, 'color: #3498db', 0]);
                } else {
                    Object.entries(statusCounts).forEach(([status, count]) => {
                        // Default to blue
                        let color = 'color: #3498db';

                        // Color each status consistently:
                        if (status === 'Over Due') {
                            color = 'color: #e74c3c';   // Red
                        } else if (status === 'Up-Comming') {
                            color = 'color: #91830d';  // Brownish
                        } else if (status === 'Today') {
                            color = 'color: #27ae60';  // Green
                        }

                        chartData.push([status, Number(count), color, Number(count)]);
                    });
                }

                const dataTable = google.visualization.arrayToDataTable(chartData);
                const options = {
                    title: "Doer-Wise Status Count (Columns Chart)",
                    legend: { position: 'none' },
                    chartArea: { width: '70%', left: '15%' },
                    annotations: {
                        alwaysOutside: true,
                        textStyle: { fontSize: 12, color: '#000' }
                    },
                    hAxis: { title: 'Count' },
                    vAxis: { title: 'Status' }
                };

                const chart = new google.visualization.ColumnChart(
                    document.getElementById('pie_chart_div2')
                );
                chart.draw(dataTable, options);

                // Store references
                window.myBarChart3 = chart;
                window.myBarChart3Data = dataTable;
                window.myBarChart3Options = options;
            }

            // 5) Called by renderTable() after filtering to update charts
            function updateCharts(filteredData) {
                const taskCounts = {};
                const statusCounts = {};
                const doerCounts = {};

                filteredData.forEach(row => {
                    const process = row[2];
                    const doer = row[1];
                    const status = row[6];
                    doerCounts[doer] = (doerCounts[doer] || 0) + 1;
                    taskCounts[process] = (taskCounts[process] || 0) + 1;
                    statusCounts[status] = (statusCounts[status] || 0) + 1;
                });

                drawBarChart(taskCounts);
                drawPieChart(statusCounts);
                drawBarChart2(doerCounts);
                drawBarChart3(statusCounts);
            }
        }

        // Load User Management page
        function loadUserManagement() {
            const userName = localStorage.getItem('userName');
            const role = localStorage.getItem('role');

            if (!userName || !role) {
                displayAlertMessage('Please login first', 'warning');
                return;
            }

            // Hide iframe and show sheet content
            document.getElementById('linkContent').style.display = 'none';
            document.getElementById('sheetContent').style.display = 'block';

            // Show loader
            const globalLoader = document.getElementById('globalLoader');
            if (globalLoader) globalLoader.style.display = 'flex';

            // Clear any existing timers from other pages
            if (window.refreshTextTimeout) {
                clearTimeout(window.refreshTextTimeout);
                window.refreshTextTimeout = null;
            }

            // Load User Management page HTML
            google.script.run
                .withSuccessHandler(function (html) {
                    const sheetContent = document.getElementById('sheetContent');
                    sheetContent.innerHTML = html;

                    // Wait a brief moment for DOM to be ready, then initialize
                    setTimeout(function () {
                        // Evaluate any <script> tags inside the returned HTML
                        const scripts = sheetContent.querySelectorAll("script");
                        scripts.forEach(scr => {
                            try {
                                eval(scr.innerHTML);
                            } catch (error) {
                                console.error('Error evaluating User Management script:', error);
                            }
                        });

                        // Ensure Google Apps Script context is available and trigger initialization
                        if (typeof window.initializeUserManagementPage === 'function') {
                            window.initializeUserManagementPage();
                        } else {
                            console.error('initializeUserManagementPage function not found!');
                        }

                        if (globalLoader) globalLoader.style.display = 'none';
                    }, 100);
                })
                .withFailureHandler(function (err) {
                    console.error('Failed to load User Management page:', err);
                    const sheetContent = document.getElementById('sheetContent');
                    sheetContent.innerHTML = '<div style="padding: 50px; text-align: center;"><h3>Error loading User Management page</h3><p>' + err + '</p></div>';
                    if (globalLoader) globalLoader.style.display = 'none';
                })
                .getUserManagementPageHtml(userName, role);
        }

        // Handle login process
        function handleLogin() {
            const usernameInput = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const role = document.getElementById('role').value;
            const loader = document.getElementById('globalLoader');

            // Show loader before starting the login process
            loader.style.display = 'flex';

            google.script.run.withSuccessHandler(function (response) {
                // Hide the loader once the login process is complete
                loader.style.display = 'none';

                if (response.success) {
                    displayAlertMessage('Login successful!', 'success');
                    // Store in localStorage so we can pick it up on first load
                    localStorage.setItem('userName', usernameInput);
                    localStorage.setItem('role', role);

                    localStorage.setItem('displayName', response.displayName);
                    localStorage.setItem('metricsVisible', response.metricsVisible);
                    localStorage.setItem('profilePictureUrl', response.profilePictureUrl || '');

                    userName = usernameInput; // update the global variable

                    showMainContainer(usernameInput, response.displayName, response.profilePictureUrl);
                    // Build the sidebar
                    google.script.run.withSuccessHandler(buildSidebar).getMenuStructure(usernameInput);
                    // Now load the home page
                    loadHomePage();

                    document.getElementById('logoutButton').style.display = 'block';
                    document.getElementById('welcomeMessage').style.display = 'block';
                    document.getElementById('sidebar').style.display = 'block';

                    // Reset the inactivity timer
                    resetInactivityTimer();
                } else {
                    displayAlertMessage('Invalid username, password, or role.', 'danger');
                }
            }).checkLogin(usernameInput, password, role);
        }

        // Handle logout
        function handleLogout() {
            // Clear all timers when logging out
            clearAllTimers();

            // Existing logout code...
            const responseMessage = document.getElementById('responseMessage');
            const loader = document.getElementById('globalLoader');

            // Clear localStorage and sessionStorage so stale data isn't reused
            localStorage.removeItem('userName');
            localStorage.removeItem('role');
            localStorage.removeItem('displayName');
            localStorage.removeItem('metricsVisible');
            localStorage.removeItem('profilePictureUrl');
            sessionStorage.clear();

            // Clear the iframe's source (in case it was displaying a submenu link)
            document.getElementById('linkFrame').src = "";

            // Reset UI elements
            showLoginContainer();
            document.getElementById('profileTrigger').style.display = 'none';
            document.getElementById('sidebar').style.display = "none";
            document.getElementById('burger').style.display = 'none';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('role').value = '';

            console.log("After logout - userName:", "");
            console.log("After logout - role:", "");

            // Show loader while logging out
            loader.style.display = 'flex';

            // Hide loader and show logout message after a short delay
            setTimeout(() => {
                loader.style.display = 'none';
                displayAlertMessage('Logout successful!', 'danger');
                onLoad(); // Reload the initial state
            }, 1000);
        }

        // Function to display alert message
        function displayAlertMessage(message, type) {
            const responseMessage = document.getElementById('responseMessage');
            responseMessage.innerText = message;
            responseMessage.className = `alert alert-${type}`;
            responseMessage.style.display = 'block';

            // Hide the alert after a few seconds
            setTimeout(() => {
                responseMessage.style.display = 'none';
            }, 3000); // Adjust timing as needed
        }

        // Toggle sidebar visibility
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContainer = document.getElementById('mainContainer');
            // Toggle the sidebar visibility
            sidebar.classList.toggle('show');
            // Adjust the main container width
            mainContainer.classList.toggle('with-sidebar');
        }

        function togglePasswordVisibility() {
            const passwordField = document.getElementById("password");
            const toggleIcon = document.getElementById("togglePassword");
            if (passwordField.type === "password") {
                passwordField.type = "text";
                toggleIcon.classList.remove("fa-eye");
                toggleIcon.classList.add("fa-eye-slash");
            } else {
                passwordField.type = "password";
                toggleIcon.classList.remove("fa-eye-slash");
                toggleIcon.classList.add("fa-eye");
            }
        }

        function openEnlargedGraph(originalChartDivId, chartType, chartData, chartOptions) {
            // Create the overlay element
            const overlay = document.createElement('div');
            overlay.className = 'enlarged-overlay';

            // When clicking on overlay (outside the container), close the overlay with animation
            overlay.addEventListener('click', function (e) {
                if (e.target === overlay) {
                    closeOverlay(overlay);
                }
            });

            // Create the container that will hold the enlarged graph
            const container = document.createElement('div');
            container.className = 'enlarged-container';

            // Create a close button
            const closeButton = document.createElement('button');
            closeButton.className = 'close-btn';
            closeButton.innerHTML = '&times;';
            closeButton.onclick = function (e) {
                // Prevent the click from bubbling to the overlay
                e.stopPropagation();
                closeOverlay(overlay);
            };
            container.appendChild(closeButton);

            // (Optional) Copy the title from the original card if available
            const originalCard = document.getElementById(originalChartDivId).closest('.card');
            if (originalCard) {
                const titleEl = originalCard.querySelector('.card-title');
                if (titleEl) {
                    const titleClone = titleEl.cloneNode(true);
                    container.appendChild(titleClone);
                }
            }

            // Create a new div to host the enlarged chart
            const enlargedChartDiv = document.createElement('div');
            enlargedChartDiv.style.width = '100%';
            // Reserve some height for the close button and optional title (adjust as needed)
            enlargedChartDiv.style.height = 'calc(100% - 40px)';
            container.appendChild(enlargedChartDiv);

            // Append container to overlay and overlay to document body
            overlay.appendChild(container);
            document.body.appendChild(overlay);

            // Force reflow so that the animation will trigger
            window.getComputedStyle(overlay).opacity;

            // Add the "show" class to start the opening animation
            overlay.classList.add('show');
            container.classList.add('show');

            // Draw the chart into the new container
            let chart;
            if (chartType === 'barChart') {
                chart = new google.visualization.ColumnChart(enlargedChartDiv);
            } else if (chartType === 'pieChart') {
                chart = new google.visualization.PieChart(enlargedChartDiv);
            }
            // Add further conditions if you have more chart types

            chart.draw(chartData, chartOptions);
        }

        // Helper function to close the overlay with an animation
        function closeOverlay(overlay) {
            // Remove the "show" class to trigger the closing animation
            overlay.classList.remove('show');
            const container = overlay.querySelector('.enlarged-container');
            if (container) {
                container.classList.remove('show');
            }
            // Wait for the transition to finish (300ms) before removing from the DOM
            setTimeout(function () {
                if (overlay.parentNode) {
                    overlay.parentNode.removeChild(overlay);
                }
            }, 300);
        }

        function safeString(str) {
            if (!str) return '';
            return String(str)
                .replace(/'/g, "\\'")      // escape single quotes
                .replace(/\r?\n/g, ' ');   // remove newlines
        }

        function initializeMisScore() {
            console.log('Initializing MIS Score section...');
            // Show MIS section
            document.getElementById('misScoreSection').style.display = 'block';

            // Wait a moment for the DOM to be ready, then setup filters
            setTimeout(function () {
                setupScoreCommonFilters();

                // Initialize with MIS tab active
                currentActiveTab = 'mis';
            }, 100);
        }

        function resetScoreFilters() {
            console.log('Resetting score filters to current week...');

            // Calculate current Monday
            const today = new Date();
            const mondayOfCurrentWeek = new Date(today);
            const dayOfWeek = today.getDay();
            const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
            mondayOfCurrentWeek.setDate(today.getDate() + mondayOffset);

            // Set dates
            const startDateStr = mondayOfCurrentWeek.toISOString().split('T')[0];
            const scoreStartDate = document.getElementById('scoreStartDate');
            const scoreEndDate = document.getElementById('scoreEndDate');

            if (scoreStartDate) {
                scoreStartDate.value = startDateStr;
                updateScoreEndDate();
                updateScoreWeekSelection();
            }

            // Reset user filters to all selected
            const userCheckboxes = document.querySelectorAll('.score-user-checkbox');
            if (userCheckboxes.length > 0) {
                selectAllScoreUsers();
            }

            // Hide user filter if only one user
            const userFilterContainer = document.getElementById('scoreUserFilterContainer');
            if (userFilterContainer && userCheckboxes.length <= 1) {
                userFilterContainer.style.display = 'none';
            }

            // Load data for current tab
            setTimeout(function () {
                loadCurrentTabData();
            }, 100);

            console.log('Score filters reset to current week:', startDateStr);
        }

        // Make reset function globally available  
        window.resetScoreFilters = resetScoreFilters;

        function renderMisTable(data) {
            const tbody = document.getElementById('misTableBody');
            tbody.innerHTML = '';

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12" class="text-center">No MIS data found for selected date range</td></tr>';
                return;
            }

            // Setup user filter if more than 1 user (reuse the common function)
            setupScoreUserFilter(data);

            // Apply user filter and render
            renderFilteredMisTable(data);
        }

        // Add this new function for MIS table rendering
        function renderFilteredMisTable(data) {
            const filteredData = applyScoreUserFilter(data);
            const tbody = document.getElementById('misTableBody');
            tbody.innerHTML = '';

            filteredData.forEach(function (row) {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                  <td style="text-align: center; border: 1px solid #dee2e6; padding: 8px;">${row.userId}</td>
                  <td style="text-align: center; border: 1px solid #dee2e6; padding: 8px;">${row.name}</td>
                  <td style="text-align: center; border: 1px solid #dee2e6; padding: 8px;">${row.currentWeekScoreWND}</td>
                  <td style="text-align: center; border: 1px solid #dee2e6; padding: 8px;">${row.totalTasks}</td>
                  <td style="text-align: center; border: 1px solid #dee2e6; padding: 8px;">${row.totalCompletedTasks}</td>
                  <td style="text-align: center; border: 1px solid #dee2e6; padding: 8px;">${row.wndScore}</td>
                  <td style="text-align: center; border: 1px solid #dee2e6; padding: 8px;">${row.nextCommitmentWND}</td>
                  <td style="text-align: center; border: 1px solid #dee2e6; padding: 8px;">${row.currentWeekScoreWNDOT}</td>
                  <td style="text-align: center; border: 1px solid #dee2e6; padding: 8px;">${row.totalCompleteTasks}</td>
                  <td style="text-align: center; border: 1px solid #dee2e6; padding: 8px;">${row.onTimeDoneTasks}</td>
                  <td style="text-align: center; border: 1px solid #dee2e6; padding: 8px;">${row.wndotScore}</td>
                  <td style="text-align: center; border: 1px solid #dee2e6; padding: 8px;">${row.nextCommitmentWNDOT}</td>
                  <td style="text-align: center; border: 1px solid #dee2e6; padding: 8px;">
                    <button onclick="viewMisProcessDetails('${row.userId}', '${row.name}')" 
                            style="background-color: #1A7499; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                      View
                    </button>
                  </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Prevent dropdown from closing when clicking inside
        document.addEventListener('DOMContentLoaded', function () {
            const dropdown = document.getElementById('misUserDropdown');
            if (dropdown) {
                dropdown.addEventListener('click', function (e) {
                    e.stopPropagation();
                });
            }
        });

        function viewMisProcessDetails(userId, userName) {
            const startDate = document.getElementById('scoreStartDate').value;
            const endDate = document.getElementById('scoreEndDate').value;

            // Show modal immediately with loading
            showMisProcessModalWithLoading(userId, userName, startDate, endDate);

            // Then fetch data
            google.script.run
                .withSuccessHandler(function (result) {
                    if (result.success) {
                        populateMisProcessModal(result.data);
                    } else {
                        showMisProcessModalError('Error: ' + result.error);
                    }
                })
                .withFailureHandler(function (error) {
                    showMisProcessModalError('Error loading process details: ' + error);
                })
                .getProcessDetails(userId, startDate, endDate);
        }

        function showMisProcessModalWithLoading(userId, userName, startDate, endDate) {
            document.getElementById('misModalTitle').textContent = `Process Details - ${userName}`;
            document.getElementById('misModalSubtitle').textContent = `${userId} | ${startDate} to ${endDate}`;

            const container = document.getElementById('misProcessTableContainer');
            container.innerHTML = `
                <div style="display: flex; justify-content: center; align-items: center; padding: 50px;">
                  <div style="border: 4px solid #f3f3f3; border-top: 4px solid #1A7499; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite;"></div>
                </div>
              `;

            document.getElementById('misProcessModal').style.display = 'flex';
        }

        function populateMisProcessModal(processData) {
            const container = document.getElementById('misProcessTableContainer');
            container.innerHTML = '';

            if (processData.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 20px;">No process data found for selected date range</p>';
            } else {
                const table = document.createElement('table');
                table.style.width = '100%';
                table.style.borderCollapse = 'collapse';

                table.innerHTML = `
                  <thead>
                    <tr>
                      <th style="background-color: #1A7499; color: white; padding: 10px; border: 1px solid #dee2e6;">Process Name</th>
                      <th style="background-color: #1A7499; color: white; padding: 10px; border: 1px solid #dee2e6;">Total Task</th>
                      <th style="background-color: #1A7499; color: white; padding: 10px; border: 1px solid #dee2e6;">Total Completed</th>
                      <th style="background-color: #1A7499; color: white; padding: 10px; border: 1px solid #dee2e6;">Task Score</th>
                      <th style="background-color: #1A7499; color: white; padding: 10px; border: 1px solid #dee2e6;">Total Complete Task</th>
                      <th style="background-color: #1A7499; color: white; padding: 10px; border: 1px solid #dee2e6;">On Time Done Task</th>
                      <th style="background-color: #1A7499; color: white; padding: 10px; border: 1px solid #dee2e6;">Time Score</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${processData.map(process => `
                      <tr>
                        <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center;">${process.processName}</td>
                        <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center;">${process.totalTasks}</td>
                        <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center;">${process.totalCompleted}</td>
                        <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center;">${process.taskScore}</td>
                        <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center;">${process.totalCompleteTasks}</td>
                        <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center;">${process.onTimeDoneTasks}</td>
                        <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center;">${process.timeScore}</td>
                      </tr>
                    `).join('')}
                  </tbody>
                `;

                container.appendChild(table);
            }
        }

        function showMisProcessModalError(errorMessage) {
            const container = document.getElementById('misProcessTableContainer');
            container.innerHTML = `<p style="text-align: center; color: red; padding: 20px;">${errorMessage}</p>`;
        }

        function showMisProcessModal(processData, userId, userName, startDate, endDate) {
            document.getElementById('misModalTitle').textContent = `Process Details - ${userName}`;
            document.getElementById('misModalSubtitle').textContent = `${userId} | ${startDate} to ${endDate}`;

            const container = document.getElementById('misProcessTableContainer');
            container.innerHTML = '';

            if (processData.length === 0) {
                container.innerHTML = '<p style="text-align: center;">No process data found for selected date range</p>';
            } else {
                const table = document.createElement('table');
                table.style.width = '100%';
                table.style.borderCollapse = 'collapse';

                table.innerHTML = `
                  <thead>
                    <tr>
                      <th style="background-color: #1A7499; color: white; padding: 10px; border: 1px solid #dee2e6;">Process Name</th>
                      <th style="background-color: #1A7499; color: white; padding: 10px; border: 1px solid #dee2e6;">Total Task</th>
                      <th style="background-color: #1A7499; color: white; padding: 10px; border: 1px solid #dee2e6;">Total Completed</th>
                      <th style="background-color: #1A7499; color: white; padding: 10px; border: 1px solid #dee2e6;">Task Score</th>
                      <th style="background-color: #1A7499; color: white; padding: 10px; border: 1px solid #dee2e6;">Total Complete Task</th>
                      <th style="background-color: #1A7499; color: white; padding: 10px; border: 1px solid #dee2e6;">On Time Done Task</th>
                      <th style="background-color: #1A7499; color: white; padding: 10px; border: 1px solid #dee2e6;">Time Score</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${processData.map(process => `
                      <tr>
                        <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center;">${process.processName}</td>
                        <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center;">${process.totalTasks}</td>
                        <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center;">${process.totalCompleted}</td>
                        <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center;">${process.taskScore}</td>
                        <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center;">${process.totalCompleteTasks}</td>
                        <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center;">${process.onTimeDoneTasks}</td>
                        <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center;">${process.timeScore}</td>
                      </tr>
                    `).join('')}
                  </tbody>
                `;

                container.appendChild(table);
            }

            document.getElementById('misProcessModal').style.display = 'flex';
        }

        function closeMisProcessModal() {
            document.getElementById('misProcessModal').style.display = 'none';
        }

        // Close modal when clicking outside
        document.addEventListener('click', function (e) {
            const modal = document.getElementById('misProcessModal');
            if (e.target === modal) {
                closeMisProcessModal();
            }
        });

        // Global variables for delegation
        var currentDelegationData = [];
        var currentActiveTab = 'mis';

        // Tab switching function
        function switchScoreTab(tabName) {
            currentActiveTab = tabName;
            if (tabName === 'mis') {
                loadMisData();
            } else if (tabName === 'delegation') {
                loadDelegationData();
            }
        }

        // Common filter functions
        function setupScoreCommonFilters() {
            // Load available weeks for common filters
            google.script.run
                .withSuccessHandler(function (weeks) {
                    const weekSelect = document.getElementById('scoreWeekNumber');
                    if (!weekSelect) {
                        console.error('scoreWeekNumber element not found');
                        return;
                    }
                    weekSelect.innerHTML = '<option value="">Select Week...</option>';

                    if (weeks && weeks.length > 0) {
                        weeks.forEach(function (week) {
                            const option = document.createElement('option');
                            option.value = week.weekNumber;
                            option.textContent = week.label;
                            option.dataset.startDate = week.startDate;
                            option.dataset.endDate = week.endDate;
                            weekSelect.appendChild(option);
                        });
                    }
                })
                .withFailureHandler(function (error) {
                    console.error('Error loading weeks:', error);
                })
                .getAvailableWeeks();

            // Set default dates
            setScoreDefaultDates();

            // Setup event listeners
            const scoreStartDate = document.getElementById('scoreStartDate');
            const scoreWeekNumber = document.getElementById('scoreWeekNumber');
            const refreshScoreBtn = document.getElementById('refreshScoreBtn');

            if (scoreStartDate) {
                scoreStartDate.addEventListener('change', function () {
                    updateScoreEndDate();
                    updateScoreWeekSelection();
                    loadCurrentTabData();
                });
            }

            if (scoreWeekNumber) {
                scoreWeekNumber.addEventListener('change', function () {
                    updateScoreDatesFromWeek();
                    loadCurrentTabData();
                });
            }

            if (refreshScoreBtn) {
                refreshScoreBtn.addEventListener('click', loadCurrentTabData);
            }

            // Add reset button event listener
            const resetScoreBtn = document.getElementById('resetScoreBtn');
            if (resetScoreBtn) {
                resetScoreBtn.addEventListener('click', resetScoreFilters);
            }
        }

        function setScoreDefaultDates() {
            const today = new Date();
            const mondayOfCurrentWeek = new Date(today);
            const dayOfWeek = today.getDay();
            const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
            mondayOfCurrentWeek.setDate(today.getDate() + mondayOffset);

            const scoreStartDate = document.getElementById('scoreStartDate');
            if (scoreStartDate) {
                scoreStartDate.value = mondayOfCurrentWeek.toISOString().split('T')[0];
                updateScoreEndDate();
                updateScoreWeekSelection();

                setTimeout(loadCurrentTabData, 500);
            }
        }

        function updateScoreEndDate() {
            const scoreStartDate = document.getElementById('scoreStartDate');
            const scoreEndDate = document.getElementById('scoreEndDate');

            if (!scoreStartDate || !scoreEndDate) return;

            const startDate = scoreStartDate.value;
            if (startDate) {
                const endDate = new Date(startDate);
                endDate.setDate(endDate.getDate() + 6);
                scoreEndDate.value = endDate.toISOString().split('T')[0];
            }
        }

        function updateScoreWeekSelection() {
            const scoreStartDate = document.getElementById('scoreStartDate');
            const scoreWeekNumber = document.getElementById('scoreWeekNumber');

            if (!scoreStartDate || !scoreWeekNumber) return;

            const startDate = scoreStartDate.value;
            if (!startDate) return;

            const options = scoreWeekNumber.querySelectorAll('option');

            for (let option of options) {
                if (option.dataset.startDate === startDate) {
                    scoreWeekNumber.value = option.value;
                    break;
                }
            }
        }

        function updateScoreDatesFromWeek() {
            const scoreWeekNumber = document.getElementById('scoreWeekNumber');
            const scoreStartDate = document.getElementById('scoreStartDate');
            const scoreEndDate = document.getElementById('scoreEndDate');

            if (!scoreWeekNumber || !scoreStartDate || !scoreEndDate) return;

            const selectedOption = scoreWeekNumber.options[scoreWeekNumber.selectedIndex];

            if (selectedOption && selectedOption.dataset.startDate) {
                const startDate = selectedOption.dataset.startDate;
                const endDate = selectedOption.dataset.endDate;

                scoreStartDate.value = startDate;
                scoreEndDate.value = endDate;
            }
        }

        function loadCurrentTabData() {
            if (currentActiveTab === 'mis') {
                loadMisData();
            } else if (currentActiveTab === 'delegation') {
                loadDelegationData();
            }
        }

        // Update the loadMisData function to use the correct element IDs
        function loadMisData() {
            const startDate = document.getElementById('scoreStartDate').value;
            const endDate = document.getElementById('scoreEndDate').value;

            if (!startDate || !endDate) {
                document.getElementById('misTableBody').innerHTML = '<tr><td colspan="12" class="text-center">Please select a date range to view MIS data</td></tr>';
                return;
            }

            // Show loading
            document.getElementById('misTableBody').innerHTML = '<tr><td colspan="12" class="text-center"><div style="display: flex; justify-content: center; align-items: center;"><div style="border: 4px solid #f3f3f3; border-top: 4px solid #1A7499; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite;"></div></div></td></tr>';

            const loggedInUser = localStorage.getItem('userName');
            const loggedInRole = localStorage.getItem('role');

            google.script.run
                .withSuccessHandler(function (result) {
                    if (result.success) {
                        currentMisData = result.data;
                        renderMisTable(result.data);
                    } else {
                        console.error('MIS Error:', result.error);
                        renderMisTable([]);
                    }
                })
                .withFailureHandler(function (error) {
                    console.error('Error loading MIS data:', error);
                    renderMisTable([]);
                })
                .calculateMISScores(loggedInUser, loggedInRole, startDate, endDate);
        }

        // Update the loadDelegationData function to use the correct element IDs
        function loadDelegationData() {
            const startDate = document.getElementById('scoreStartDate').value;
            const endDate = document.getElementById('scoreEndDate').value;

            if (!startDate || !endDate) {
                document.getElementById('delegationTableBody').innerHTML = '<tr><td colspan="15" class="text-center">Please select a date range to view delegation data</td></tr>';
                return;
            }

            // Show loading
            document.getElementById('delegationTableBody').innerHTML = '<tr><td colspan="15" class="text-center"><div style="display: flex; justify-content: center; align-items: center;"><div style="border: 4px solid #f3f3f3; border-top: 4px solid #1A7499; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite;"></div></div></td></tr>';

            const loggedInUser = localStorage.getItem('userName');
            const loggedInRole = localStorage.getItem('role');

            google.script.run
                .withSuccessHandler(function (result) {
                    if (result.success) {
                        currentDelegationData = result.data;
                        renderDelegationTable(result.data);
                    } else {
                        console.error('Delegation Error:', result.error);
                        renderDelegationTable([]);
                    }
                })
                .withFailureHandler(function (error) {
                    console.error('Error loading delegation data:', error);
                    renderDelegationTable([]);
                })
                .calculateDelegationScores(loggedInUser, loggedInRole, startDate, endDate);
        }

        function renderDelegationTable(data) {
            const tbody = document.getElementById('delegationTableBody');
            tbody.innerHTML = '';

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="15" class="text-center">No delegation data found for selected date range</td></tr>';
                return;
            }

            // Setup user filter if more than 1 user
            setupScoreUserFilter(data);

            // Apply user filter and render
            renderFilteredDelegationTable(data);
        }

        function setupScoreUserFilter(data) {
            const userFilterContainer = document.getElementById('scoreUserFilterContainer');

            if (data.length <= 1) {
                userFilterContainer.style.display = 'none';
                return;
            }

            userFilterContainer.style.display = 'block';

            // Get unique users
            const users = [];
            const seen = new Set();
            data.forEach(row => {
                if (!seen.has(row.userId)) {
                    seen.add(row.userId);
                    users.push({ userId: row.userId, name: row.name });
                }
            });

            // Check if we need to rebuild the dropdown
            const existingCheckboxes = document.querySelectorAll('.score-user-checkbox');
            const existingUserIds = Array.from(existingCheckboxes).map(cb => cb.value);
            const newUserIds = users.map(u => u.userId);

            // Only rebuild if users have changed
            if (existingCheckboxes.length !== newUserIds.length ||
                !existingUserIds.every(id => newUserIds.includes(id))) {

                // Populate user checkboxes
                const checkboxContainer = document.getElementById('scoreUserCheckboxes');
                checkboxContainer.innerHTML = '';

                users.forEach(user => {
                    const div = document.createElement('div');
                    div.className = 'form-check score-user-option';
                    div.innerHTML = `
                    <input class="form-check-input score-user-checkbox" type="checkbox" value="${user.userId}" id="scoreUser_${user.userId.replace(/[^a-zA-Z0-9]/g, '_')}" checked>
                    <label class="form-check-label" for="scoreUser_${user.userId.replace(/[^a-zA-Z0-9]/g, '_')}">
                      ${user.name} (${user.userId})
                    </label>
                  `;
                    checkboxContainer.appendChild(div);
                });

                // Setup search functionality
                const searchInput = document.getElementById('scoreUserSearch');
                searchInput.removeEventListener('input', handleScoreUserSearch);
                searchInput.addEventListener('input', handleScoreUserSearch);

                // Setup checkbox change handlers
                const checkboxes = document.querySelectorAll('.score-user-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.removeEventListener('change', handleScoreUserCheckboxChange);
                    checkbox.addEventListener('change', handleScoreUserCheckboxChange);
                });

                updateScoreUserFilterDisplay(false);
            }
        }

        function handleScoreUserSearch() {
            const searchTerm = this.value.toLowerCase();
            const userOptions = document.querySelectorAll('.score-user-option');

            userOptions.forEach(option => {
                const label = option.querySelector('label').textContent.toLowerCase();
                option.style.display = label.includes(searchTerm) ? 'block' : 'none';
            });
        }

        function handleScoreUserCheckboxChange() {
            updateScoreUserFilterDisplay(true);
        }

        function updateScoreUserFilterDisplay(shouldRerender = true) {
            const checkboxes = document.querySelectorAll('.score-user-checkbox');
            const checkedBoxes = document.querySelectorAll('.score-user-checkbox:checked');
            const button = document.getElementById('scoreUserFilterBtn');

            if (checkedBoxes.length === 0) {
                button.textContent = 'No Users Selected';
            } else if (checkedBoxes.length === checkboxes.length) {
                button.textContent = 'All Users';
            } else if (checkedBoxes.length === 1) {
                const label = checkedBoxes[0].nextElementSibling.textContent.split(' (')[0];
                button.textContent = label;
            } else {
                button.textContent = `${checkedBoxes.length} Users Selected`;
            }

            // Only re-render if requested and data exists
            if (shouldRerender && currentActiveTab === 'delegation' && currentDelegationData && currentDelegationData.length > 0) {
                renderFilteredDelegationTable(currentDelegationData);
            } else if (shouldRerender && currentActiveTab === 'mis' && currentMisData && currentMisData.length > 0) {
                renderFilteredMisTable(currentMisData);
            }
        }

        function applyScoreUserFilter(data) {
            const checkboxes = document.querySelectorAll('.score-user-checkbox:checked');

            if (checkboxes.length === 0) {
                return data;
            }

            const selectedUserIds = Array.from(checkboxes).map(cb => cb.value);
            return data.filter(row => selectedUserIds.includes(row.userId));
        }

        function selectAllScoreUsers() {
            const checkboxes = document.querySelectorAll('.score-user-checkbox');
            checkboxes.forEach(checkbox => checkbox.checked = true);
            updateScoreUserFilterDisplay(true);
        }

        function clearAllScoreUsers() {
            const checkboxes = document.querySelectorAll('.score-user-checkbox');
            checkboxes.forEach(checkbox => checkbox.checked = false);
            updateScoreUserFilterDisplay(true);
        }

        function renderFilteredDelegationTable(data) {
            const filteredData = applyScoreUserFilter(data);
            const tbody = document.getElementById('delegationTableBody');
            tbody.innerHTML = '';

            const loggedInRole = localStorage.getItem('role');
            const canEdit = (loggedInRole === 'admin');

            filteredData.forEach(function (row) {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                  <td style="text-align: center; border: 1px solid #dee2e6; padding: 8px;">${row.userId}</td>
                  <td style="text-align: center; border: 1px solid #dee2e6; padding: 8px;">${row.name}</td>
                  <td style="text-align: center; border: 1px solid #dee2e6; padding: 8px; background-color: #ffebee;">${row.currentPlannedRed}</td>
                  <td style="text-align: center; border: 1px solid #dee2e6; padding: 8px; background-color: #fff8e1;">${row.currentPlannedYellow}</td>
                  <td style="text-align: center; border: 1px solid #dee2e6; padding: 8px; background-color: #e8f5e8;">${row.currentPlannedGreen}</td>
                  <td style="text-align: center; border: 1px solid #dee2e6; padding: 8px; background-color: #ffebee;">
                    <div>${row.currentScoreRedCount || 0}</div>
                    <div style="font-size: 11px; color: #666;">(${row.currentScoreRed}%)</div>
                  </td>
                  <td style="text-align: center; border: 1px solid #dee2e6; padding: 8px; background-color: #fff8e1;">
                    <div>${row.currentScoreYellowCount || 0}</div>
                    <div style="font-size: 11px; color: #666;">(${row.currentScoreYellow}%)</div>
                  </td>
                  <td style="text-align: center; border: 1px solid #dee2e6; padding: 8px; background-color: #e8f5e8;">
                    <div>${row.currentScoreGreenCount || 0}</div>
                    <div style="font-size: 11px; color: #666;">(${row.currentScoreGreen}%)</div>
                  </td>
                  <td style="text-align: center; border: 1px solid #dee2e6; padding: 8px;">${row.totalTasks}</td>
                  <td style="text-align: center; border: 1px solid #dee2e6; padding: 8px;">${row.completedTasks}</td>
                  <td style="text-align: center; border: 1px solid #dee2e6; padding: 8px;">${row.pendingTasks}</td>
                  <td style="text-align: center; border: 1px solid #dee2e6; padding: 8px;">${row.shiftedTasks}</td>
                  <td style="text-align: center; border: 1px solid #dee2e6; padding: 8px; background-color: #ffebee;">${row.nextCommittedRed || ''}</td>
                  <td style="text-align: center; border: 1px solid #dee2e6; padding: 8px; background-color: #fff8e1;">${row.nextCommittedYellow || ''}</td>
                  <td style="text-align: center; border: 1px solid #dee2e6; padding: 8px; background-color: #e8f5e8;">${row.nextCommittedGreen || ''}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Delegation saving functionality
        var hasDelegationUnsavedChanges = false;

        function markDelegationUnsaved() {
            hasDelegationUnsavedChanges = true;
            showDelegationSaveButton();
        }

        function showDelegationSaveButton() {
            let saveBtn = document.getElementById('saveDelegationBtn');
            if (!saveBtn) {
                // Create save button if it doesn't exist
                const refreshBtn = document.getElementById('refreshScoreBtn');
                saveBtn = document.createElement('button');
                saveBtn.id = 'saveDelegationBtn';
                saveBtn.className = 'btn btn-success ms-2';
                saveBtn.textContent = 'Save Delegation Changes';
                saveBtn.onclick = saveDelegationChanges;
                refreshBtn.parentNode.appendChild(saveBtn);
            }
            saveBtn.style.display = 'inline-block';
        }

        function saveDelegationChanges() {
            if (!hasDelegationUnsavedChanges) return;

            const startDate = document.getElementById('scoreStartDate').value;
            const endDate = document.getElementById('scoreEndDate').value;
            const weekSelect = document.getElementById('scoreWeekNumber');
            const weekNumber = weekSelect.value || getCurrentWeekNumber(startDate);

            if (!weekNumber) {
                alert('Please select a valid week number');
                return;
            }

            const commitmentInputs = document.querySelectorAll('.delegation-commitment-input:not([disabled])');
            const commitments = {};

            commitmentInputs.forEach(function (input) {
                const userId = input.dataset.user;
                const type = input.dataset.type;
                const value = input.value ? input.value.trim() : '';

                if (value !== '') {
                    if (!commitments[userId]) {
                        commitments[userId] = { red: '', yellow: '', green: '' };
                    }
                    commitments[userId][type] = value;
                }
            });

            if (Object.keys(commitments).length === 0) {
                alert('No commitments to save - please enter values before saving');
                hasDelegationUnsavedChanges = false;
                document.getElementById('saveDelegationBtn').style.display = 'none';
                return;
            }

            // Show loading state
            const saveBtn = document.getElementById('saveDelegationBtn');
            const originalText = saveBtn.textContent;
            saveBtn.textContent = 'Saving...';
            saveBtn.disabled = true;

            // Save commitments sequentially
            let saveCount = 0;
            const totalSaves = Object.keys(commitments).length;
            let hasError = false;

            function saveNext() {
                const userIds = Object.keys(commitments);
                if (saveCount >= totalSaves || hasError) {
                    saveBtn.textContent = originalText;
                    saveBtn.disabled = false;
                    if (!hasError) {
                        hasDelegationUnsavedChanges = false;
                        saveBtn.style.display = 'none';
                        alert('All delegation commitments saved successfully');
                        loadDelegationData();
                    }
                    return;
                }

                const userId = userIds[saveCount];
                const redCommitment = commitments[userId].red || '';
                const yellowCommitment = commitments[userId].yellow || '';
                const greenCommitment = commitments[userId].green || '';

                google.script.run
                    .withSuccessHandler(function () {
                        saveCount++;
                        saveNext();
                    })
                    .withFailureHandler(function (error) {
                        hasError = true;
                        saveBtn.textContent = originalText;
                        saveBtn.disabled = false;
                        alert('Error saving delegation commitments: ' + error);
                    })
                    .saveDelegationWorkCommitments(userId, weekNumber, startDate, endDate, redCommitment, yellowCommitment, greenCommitment);
            }

            saveNext();
        }

        function getCurrentWeekNumber(dateStr) {
            if (!dateStr) return null;

            // Try to use the same logic as the backend getWeekNumber function
            const date = new Date(dateStr);

            // Check if there are available weeks in the dropdown first
            const weekSelect = document.getElementById('scoreWeekNumber');
            if (weekSelect) {
                const options = weekSelect.querySelectorAll('option');

                for (let option of options) {
                    if (option.dataset.startDate === dateStr) {
                        return parseInt(option.value);
                    }
                }
            }

            // Fallback to calculation
            const startOfYear = new Date(date.getFullYear(), 0, 1);
            const diffInTime = date.getTime() - startOfYear.getTime();
            const diffInDays = Math.ceil(diffInTime / (1000 * 3600 * 24));
            return Math.ceil(diffInDays / 7);
        }

        // --- Profile Dropdown Logic ---
        function toggleProfileDropdown(event) {
            event.stopPropagation();
            const dropdown = document.getElementById('userDropdownMenu');
            dropdown.classList.toggle('show');
        }

        // Close dropdown when clicking outside
        window.addEventListener('click', function (e) {
            const dropdown = document.getElementById('userDropdownMenu');
            const trigger = document.getElementById('profileTrigger');

            if (dropdown && dropdown.classList.contains('show')) {
                if (!trigger.contains(e.target)) {
                    dropdown.classList.remove('show');
                }
            }
        });

    </script>
</body>

</html>